<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.2 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Premeeting - Geospatial Workbook</title>
<meta name="description" content="Tutorial on Informatics for Geospatial Information">


  <meta name="author" content="Laura Boucheron">


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Geospatial Workbook">
<meta property="og:title" content="Premeeting">
<meta property="og:url" content="http://localhost:4000/IntroductionToImageAnalysis/Tutorial5_Advanced_DL_Networks.html">




  <meta property="og:image" content="http://localhost:4000/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg">



  <meta name="twitter:site" content="@isugif">
  <meta name="twitter:title" content="Premeeting">
  <meta name="twitter:description" content="Tutorial on Informatics for Geospatial Information">
  <meta name="twitter:url" content="http://localhost:4000/IntroductionToImageAnalysis/Tutorial5_Advanced_DL_Networks.html">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg">
  

  
    <meta name="twitter:creator" content="@someone">
  







  

  


<link rel="canonical" href="http://localhost:4000/IntroductionToImageAnalysis/Tutorial5_Advanced_DL_Networks.html">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Geospatial Workbook Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E6BZVYF8ZY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E6BZVYF8ZY');
</script>

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Geospatial Workbook</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about.html" >About</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/list.html" >Index</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/glossary.html" >Glossary</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/people.html" >People</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/contributing.html" >Contribute</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style="background-color: 444444; background-image: url('/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Premeeting

        
      </h1>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/people/LauraBoucheron.jpg" alt="Laura Boucheron" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Laura Boucheron</h3>
    
    
      <p class="author__bio" itemprop="description">
        Laura E. Boucheron received the B.S. and M.S. degrees in electrical engineering from New Mexico State University, Las Cruces, in 2001 and 2003, respectively, and the Ph.D. degree in electrical and computer engineering from the University of California, Santa Barbara, in 2008. She has intern and graduate research experience at both Sandia National Laboratories and Los Alamos National Laboratory and postdoctoral and research faculty experience in the Klipsch School of Electrical and Computer Engineering at New Mexico State University. She is currently an Associate Professor in the Klipsch School. Her teaching interests include signals & systems, digital signal processing, digital image processing, and pattern recognition and machine learning. Her research interests include image analysis, feature extraction, pattern recognition and machine learning, temporal image analysis, interdisciplinary research, solar image analysis, and biomedical image analysis.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      
        <li>
          <a href="mailto:mailto:someone@iastate.edu">
            <meta itemprop="email" content="mailto:someone@iastate.edu" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/someone" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

<!-- Create a 2nd author for tutorials -->



<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Premeeting">
    
    
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <h1 id="tutorial-5-advanced-dl-networks">Tutorial 5: Advanced DL Networks</h1>
<h2 id="laura-e-boucheron-electrical--computer-engineering-nmsu">Laura E. Boucheron, Electrical &amp; Computer Engineering, NMSU</h2>
<h3 id="october-2020">October 2020</h3>
<p>Copyright (C) 2020  Laura E. Boucheron</p>

<p>This information is free; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version.</p>

<p>This work is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License along with this work; if not, If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>

<h2 id="overview">Overview</h2>
<p>In this tutorial, we study some more deep learning architectures for both image analysis and time series analysis.</p>

<p>This tutorial contains 4 sections:</p>
<ul>
  <li><strong>Section 0: Preliminaries</strong>: some notes on using this notebook, how to download the image dataset that we will use for this tutorial, and import commands for the libraries necessary for this tutorial</li>
  <li><strong>Section 1: YOLO-v3 for Object Detection</strong></li>
  <li><strong>Section 2: Mask-RCNN for Object Segmentation</strong></li>
  <li><strong>Section 3: Time Series Prediction with an LSTM</strong></li>
</ul>

<p>There are a few subsections with the heading “<strong><span style="color:Green"> Your turn: </span></strong>” throughout this tutorial in which you will be asked to apply what you have learned.</p>

<h1 id="section-0-preliminaries">Section 0: Preliminaries</h1>
<h2 id="a-note-on-jupyter-notebooks">A Note on Jupyter Notebooks</h2>

<p>There are two main types of cells in this notebook: code and markdown (text).  You can add a new cell with the plus sign in the menu bar above and you can change the type of cell with the dropdown menu in the menu bar above.  As you complete this tutorial, you may wish to add additional code cells to try out your own code and markdown cells to add your own comments or notes.</p>

<p>Markdown cells can be augmented with a number of text formatting features, including</p>
<ul>
  <li>bulleted</li>
  <li>lists</li>
</ul>

<p>embedded $\LaTeX$, monotype specification of <code class="language-plaintext highlighter-rouge">code syntax</code>, <strong>bold font</strong>, and <em>italic font</em>.  There are many other features of markdown cells–see the jupyter documentation for more information.</p>

<p>You can edit a cell by double clicking on it.  If you double click on this cell, you can see how to implement the various formatting referenced above.  Code cells can be run and markdown cells can be formatted using Shift+Enter or by selecting the Run button in the toolbar above.</p>

<p>Once you have completed (all or part) of this notebook, you can share your results with colleagues by sending them the <code class="language-plaintext highlighter-rouge">.ipynb</code> file.  Your colleagues can then open the file and will see your markdown and code cells as well as any results that were printed or displayed at the time you saved the notebook.  If you prefer to send a notebook without results displayed (like this notebook appeared when you downloaded it), you can select (“Restart &amp; Clear Output”) from the Kernel menu above.  You can also export this notebook in a non-executable form, e.g., <code class="language-plaintext highlighter-rouge">.pdf</code> through the File, Save As menu.</p>

<h2 id="section-01a-import-necessary-libraries-for-users-using-a-local-machine">Section 0.1a Import Necessary Libraries (For users using a local machine)</h2>
<p>Here, at the top of the code, we import all the libraries necessary for this tutorial.  We will introduce the functionality of any new libraries throughout the tutorial, but include all import statements here as standard coding practice.  We include a brief comment after each library here to indicate its main purpose within this tutorial.</p>

<p>It would be best to run this next cell before the workshop starts to make sure you have all the necessary packages installed on your machine.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span> <span class="c1"># mathematical and scientific functions
</span><span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">dump</span>
<span class="kn">from</span> <span class="nn">unicodedata</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span> <span class="c1"># visualization
</span><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>

<span class="c1"># format matplotlib options
</span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="s">'font.size'</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">LeakyReLU</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">ZeroPadding2D</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">UpSampling2D</span>
<span class="kn">from</span> <span class="nn">keras.layers.merge</span> <span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">concatenate</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">load_img</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">img_to_array</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.text</span> <span class="kn">import</span> <span class="n">Tokenizer</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.sequence</span> <span class="kn">import</span> <span class="n">pad_sequences</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Embedding</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">RepeatVector</span>
<span class="kn">from</span> <span class="nn">keras.utils.vis_utils</span> <span class="kn">import</span> <span class="n">plot_model</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">TimeDistributed</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"Mask_RCNN/"</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mrcnn.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">mrcnn.model</span> <span class="kn">import</span> <span class="n">MaskRCNN</span>
<span class="kn">from</span> <span class="nn">mrcnn.visualize</span> <span class="kn">import</span> <span class="n">display_instances</span>
</code></pre></div></div>

<h2 id="section-01b-build-the-conda-environment-for-users-using-the-ars-hpc-ceres-with-jupyterlab">Section 0.1b Build the Conda Environment (For users using the ARS HPC Ceres with JupyterLab)</h2>
<p>Open a terminal from inside JupyterLab (File &gt; New &gt; Terminal) and type the following commands</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source activate
wget https://kerriegeil.github.io/NMSU-USDA-ARS-AI-Workshops/aiworkshop.yml
conda env create --prefix /project/your_project_name/envs/aiworkshop -f aiworkshop.yml
</code></pre></div></div>
<p>This will build the environment in one of your project directories. It may take 5 minutes to build the Conda environment.</p>

<p>See https://kerriegeil.github.io/NMSU-USDA-ARS-AI-Workshops/setup/ for more information.</p>

<p>When the environment finishes building, select this environment as your kernel in your Jupyter Notebook (click top right corner where you see Python 3, select your new kernel from the dropdown menu, click select)</p>

<p>You will want to do this BEFORE the workshop starts.</p>

<h1 id="section-1-yolo-v3-for-object-detection">Section 1 YOLO-v3 for Object Detection</h1>

<p>In this section, we will study the use of the YOLO-v3 (You Only Look Once version 3) network for object detection in images.  The papers describing the YOLO architectures can be found at:</p>
<ul>
  <li>YOLO-v1: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Redmon_You_Only_Look_CVPR_2016_paper.pdf</li>
  <li>YOLO-v2: http://openaccess.thecvf.com/content_cvpr_2017/papers/Redmon_YOLO9000_Better_Faster_CVPR_2017_paper.pdf</li>
  <li>YOLO-v3: https://arxiv.org/pdf/1804.02767.pdf</li>
</ul>

<p>The code in this section was taken and modified (slightly) from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/ and https://github.com/experiencor/keras-yolo3</p>

<p>The YOLO-v3 weights can be downloaded from: https://pjreddie.com/media/files/yolov3.weights</p>

<p>License information for the keras-yolo3 code at https://github.com/experiencor/keras-yolo3</p>

<p>MIT License</p>

<p>Copyright (c) 2017 Ngoc Anh Huynh</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the “Software”), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p>

<h3 id="define-yolo-v3-architecture-and-functions-to-load-yolo-v3-weights">Define YOLO-v3 architecture and functions to load YOLO-v3 weights</h3>
<p>These function definitions contain code to define the YOLO-v3 architecture and also to load weights for the YOLO-v3 architecture from the file linked above (https://pjreddie.com/media/files/yolov3.weights)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="k">def</span> <span class="nf">_conv_block</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">convs</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">inp</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="n">convs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">convs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">skip</span><span class="p">:</span>
            <span class="n">skip_connection</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">conv</span><span class="p">[</span><span class="s">'stride'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ZeroPadding2D</span><span class="p">(((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)))(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># peculiar padding as darknet prefer left and top
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s">'filter'</span><span class="p">],</span>\
                   <span class="n">conv</span><span class="p">[</span><span class="s">'kernel'</span><span class="p">],</span>\
                   <span class="n">strides</span><span class="o">=</span><span class="n">conv</span><span class="p">[</span><span class="s">'stride'</span><span class="p">],</span>\
                   <span class="n">padding</span><span class="o">=</span><span class="s">'valid'</span> <span class="k">if</span> <span class="n">conv</span><span class="p">[</span><span class="s">'stride'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s">'same'</span><span class="p">,</span>\
                   <span class="n">name</span><span class="o">=</span><span class="s">'conv_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s">'layer_idx'</span><span class="p">]),</span>\
                   <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span> <span class="k">if</span> <span class="n">conv</span><span class="p">[</span><span class="s">'bnorm'</span><span class="p">]</span> <span class="k">else</span> <span class="bp">True</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conv</span><span class="p">[</span><span class="s">'bnorm'</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'bnorm_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s">'layer_idx'</span><span class="p">]))(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conv</span><span class="p">[</span><span class="s">'leaky'</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'leaky_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conv</span><span class="p">[</span><span class="s">'layer_idx'</span><span class="p">]))(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">add</span><span class="p">([</span><span class="n">skip_connection</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span> <span class="k">if</span> <span class="n">skip</span> <span class="k">else</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">make_yolov3_model</span><span class="p">():</span>
    <span class="n">input_image</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># Layer  0 =&gt; 4
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>\
                                  <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>\
                                  <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>\
                                  <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}])</span>
    <span class="c1"># Layer  5 =&gt; 8
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">64</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">7</span><span class="p">}])</span>
    <span class="c1"># Layer  9 =&gt; 11
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">64</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">10</span><span class="p">}])</span>
    <span class="c1"># Layer 12 =&gt; 15
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">13</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">14</span><span class="p">}])</span>
    <span class="c1"># Layer 16 =&gt; 36
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">16</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">},</span>\
                            <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">17</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">}])</span>
    <span class="n">skip_36</span> <span class="o">=</span> <span class="n">x</span>
    <span class="c1"># Layer 37 =&gt; 40
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">37</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">38</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">39</span><span class="p">}])</span>
    <span class="c1"># Layer 41 =&gt; 61
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">41</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">},</span>\
                            <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">42</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">}])</span>
    <span class="n">skip_61</span> <span class="o">=</span> <span class="n">x</span>
    <span class="c1"># Layer 62 =&gt; 65
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">62</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">63</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">64</span><span class="p">}])</span>
    <span class="c1"># Layer 66 =&gt; 74
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">66</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">},</span>\
                            <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">67</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">}])</span>
    <span class="c1"># Layer 75 =&gt; 79
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">75</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">76</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">77</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">78</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">79</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Layer 80 =&gt; 82
</span>    <span class="n">yolo_82</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>\
                              <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span>  <span class="mi">255</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">81</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Layer 83 =&gt; 86
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">84</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">UpSampling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">skip_61</span><span class="p">])</span>
    <span class="c1"># Layer 87 =&gt; 91
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">87</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">88</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">89</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">90</span><span class="p">},</span>\
                        <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">91</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Layer 92 =&gt; 94
</span>    <span class="n">yolo_94</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">92</span><span class="p">},</span>\
                              <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">93</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Layer 95 =&gt; 98
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>   <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">96</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">UpSampling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">skip_36</span><span class="p">])</span>
    <span class="c1"># Layer 99 =&gt; 106
</span>    <span class="n">yolo_106</span> <span class="o">=</span> <span class="n">_conv_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">99</span><span class="p">},</span>\
                               <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>\
                               <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">101</span><span class="p">},</span>\
                               <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">102</span><span class="p">},</span>\
                               <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">103</span><span class="p">},</span>\
                               <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">104</span><span class="p">},</span>\
                               <span class="p">{</span><span class="s">'filter'</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="s">'kernel'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'stride'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bnorm'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'leaky'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'layer_idx'</span><span class="p">:</span> <span class="mi">105</span><span class="p">}],</span> <span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="p">[</span><span class="n">yolo_82</span><span class="p">,</span> <span class="n">yolo_94</span><span class="p">,</span> <span class="n">yolo_106</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">class</span> <span class="nc">WeightReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">weight_file</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">w_f</span><span class="p">:</span>
            <span class="n">major</span><span class="p">,</span><span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'i'</span><span class="p">,</span> <span class="n">w_f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">minor</span><span class="p">,</span><span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'i'</span><span class="p">,</span> <span class="n">w_f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">revision</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'i'</span><span class="p">,</span> <span class="n">w_f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">major</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="n">minor</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">major</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">and</span> <span class="n">minor</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">w_f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w_f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">transpose</span> <span class="o">=</span> <span class="p">(</span><span class="n">major</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="n">w_f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">all_weights</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'float32'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">all_weights</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">106</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s">'conv_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"loading weights of convolution #"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">81</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">105</span><span class="p">]:</span>
                    <span class="n">norm_layer</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s">'bnorm_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">norm_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">beta</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># bias
</span>                    <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># scale
</span>                    <span class="n">mean</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># mean
</span>                    <span class="n">var</span>   <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># variance
</span>                    <span class="n">weights</span> <span class="o">=</span> <span class="n">norm_layer</span><span class="p">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">gamma</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">bias</span>   <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">1</span><span class="p">].</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">)))</span>
                    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">conv_layer</span><span class="p">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">kernel</span><span class="p">,</span> <span class="n">bias</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">)))</span>
                    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">conv_layer</span><span class="p">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">kernel</span><span class="p">])</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"no convolution #"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div>

<h3 id="create-an-instantiation-of-the-yolo-v3-architecture-with-weights">Create an instantiation of the YOLO-v3 architecture with weights</h3>
<p>The following code instantiates a YOLO-v3 model and loads the weights pre-trained on the MSCOCO dataset (https://cocodataset.org/)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="c1"># create a YOLOv3 Keras model and save it to file
# define the model
</span><span class="n">model_yolo3</span> <span class="o">=</span> <span class="n">make_yolov3_model</span><span class="p">()</span>
<span class="c1"># load the model weights
</span><span class="n">weight_reader</span> <span class="o">=</span> <span class="n">WeightReader</span><span class="p">(</span><span class="s">'yolov3.weights'</span><span class="p">)</span>
<span class="c1"># set the model weights into the model
</span><span class="n">weight_reader</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">model_yolo3</span><span class="p">)</span>
<span class="c1"># compile the model
</span><span class="n">model_yolo3</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
<span class="c1"># save the model to file
</span><span class="n">model_yolo3</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="s">'yolov3.h5'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="what-sort-of-structure-does-yolo-v3-have">What sort of structure does YOLO-v3 have?</h3>
<p>We use the <code class="language-plaintext highlighter-rouge">print_params</code> function to display some information about the structure of the YOLO-v3 architecture.  We notice that there are a lot more layers in YOLO-v3 than we saw even in VGG16 and that there are some new kinds of layers that we haven’t encountered yet:</p>
<ul>
  <li><strong>Batch Normalization</strong> - This is a means to smooth out the statistical variations that are encountered from batch to batch in the learning process</li>
  <li><strong>LeakyReLU</strong> - Instead of pegging all negative values to 0 which can cause gradient issues when optimizing, negative values are pegged to some small value.  Thus, negative values are “leaking” through the activation.</li>
  <li><strong>ZeroPadding2D</strong> - Pads around the edge(s) of the image with zeros.</li>
  <li><strong>Add</strong> - Adds the output tensors from two layers.</li>
  <li><strong>Concatenate</strong> - Concatenates two tensors.</li>
  <li><strong>UpSampling2D</strong> - Increases the spatial dimensionality of the activations.</li>
</ul>

<p>Many of these additional layers are necessary for the “skip connections” in the YOLO architecture.  For one illustration of the skip connection and the concatenation afterwards, see Figure 4 in
L. Varela, L. E. Boucheron, N. Malone, and N. Spurlock, “Streak detection in wide field of view images using Convolutional Neural Networks (CNNs),” In proceedings: The Advanced Maui Optical and Space Surveillance Technologies Conference (AMOS), 2019. available: https://amostech.com/TechnicalPapers/2019/Machine-Learning-for-SSA-Applications/Varela.pdf</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_yolo3</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="code-to-preprocess-an-image-for-input-to-yolo-v3">Code to preprocess an image for input to YOLO-v3</h3>
<p>The following function defines a method to preprocess an image into the size expected by the YOLO-v3 network.  It also normalizes the intensities of the image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="c1"># load and prepare an image
</span><span class="k">def</span> <span class="nf">load_image_pixels</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="c1"># load the image to get its shape
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span>
    <span class="c1"># load the image with the required size
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># convert to numpy array
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># scale pixel values to [0, 1]
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">/=</span> <span class="mf">255.0</span>
    <span class="c1"># add a dimension so that we have one sample
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>
</code></pre></div></div>

<h3 id="load-an-image-and-detect-objects">Load an image and detect objects</h3>
<p>The code below loads in an example image <code class="language-plaintext highlighter-rouge">zebra.jpg</code> available from https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2019/03/zebra.jpg, preprocess it using the <code class="language-plaintext highlighter-rouge">load_image_pixels</code> function and sends that image through the YOLO-v3 network.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="c1"># load yolov3 model and perform object detection
</span>
<span class="c1"># load yolov3 model
</span><span class="n">model_yolo3</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s">'yolov3.h5'</span><span class="p">)</span>
<span class="c1"># define the expected input shape for the model
</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">=</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">416</span>
<span class="c1"># define our new photo
</span><span class="n">photo_filename</span> <span class="o">=</span> <span class="s">'zebra.jpg'</span>
<span class="c1"># load and prepare image
</span><span class="n">image</span><span class="p">,</span> <span class="n">image_w</span><span class="p">,</span> <span class="n">image_h</span> <span class="o">=</span> <span class="n">load_image_pixels</span><span class="p">(</span><span class="n">photo_filename</span><span class="p">,</span> <span class="p">(</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">))</span>
<span class="c1"># make prediction
</span><span class="n">yhat</span> <span class="o">=</span> <span class="n">model_yolo3</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="c1"># summarize the shape of the list of arrays
</span><span class="k">print</span><span class="p">(</span><span class="s">'The output from YOLO-v3 is a list of arrays of the following shapes'</span><span class="p">)</span>
<span class="k">print</span><span class="p">([</span><span class="n">a</span><span class="p">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">yhat</span><span class="p">])</span>

<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>When we plot the processed image, we note that the <code class="language-plaintext highlighter-rouge">load_image_pixels</code> function appears to simply reshape the image to the desired dimensions without condideration for the aspect ratio of the image.</p>

<p>We also notice that the prediction from YOLO-v3 is a list of arrays.  We need to somehow interpret those arrays in order to understand what has been predicted.  The following functions provide the means to interpret those arrays in terms of what objects have been detected and where in the image they have been detected.</p>

<h3 id="functions-to-decode-yolo-v3-output-and-plot-object-detection-results">Functions to decode YOLO-v3 output and plot object detection results</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="k">class</span> <span class="nc">BoundBox</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">objness</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">objness</span> <span class="o">=</span> <span class="n">objness</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">classes</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">label</span>

    <span class="k">def</span> <span class="nf">get_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">score</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">classes</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">get_label</span><span class="p">()]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">score</span>

<span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">decode_netout</span><span class="p">(</span><span class="n">netout</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">obj_thresh</span><span class="p">,</span> <span class="n">net_h</span><span class="p">,</span> <span class="n">net_w</span><span class="p">):</span>
    <span class="n">grid_h</span><span class="p">,</span> <span class="n">grid_w</span> <span class="o">=</span> <span class="n">netout</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">nb_box</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">netout</span> <span class="o">=</span> <span class="n">netout</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">grid_h</span><span class="p">,</span> <span class="n">grid_w</span><span class="p">,</span> <span class="n">nb_box</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">nb_class</span> <span class="o">=</span> <span class="n">netout</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">netout</span><span class="p">[...,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">_sigmoid</span><span class="p">(</span><span class="n">netout</span><span class="p">[...,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">netout</span><span class="p">[...,</span> <span class="mi">4</span><span class="p">:]</span>  <span class="o">=</span> <span class="n">_sigmoid</span><span class="p">(</span><span class="n">netout</span><span class="p">[...,</span> <span class="mi">4</span><span class="p">:])</span>
    <span class="n">netout</span><span class="p">[...,</span> <span class="mi">5</span><span class="p">:]</span>  <span class="o">=</span> <span class="n">netout</span><span class="p">[...,</span> <span class="mi">4</span><span class="p">][...,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">netout</span><span class="p">[...,</span> <span class="mi">5</span><span class="p">:]</span>
    <span class="n">netout</span><span class="p">[...,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">netout</span><span class="p">[...,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">obj_thresh</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_h</span><span class="o">*</span><span class="n">grid_w</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">grid_w</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">grid_w</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_box</span><span class="p">):</span>
            <span class="c1"># 4th element is objectness score
</span>            <span class="n">objectness</span> <span class="o">=</span> <span class="n">netout</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)][</span><span class="n">b</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">objectness</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">obj_thresh</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c1"># first 4 elements are x, y, w, and h
</span>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">netout</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)][</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)][</span><span class="n">b</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_w</span> <span class="c1"># center position, unit: image width
</span>            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">grid_h</span> <span class="c1"># center position, unit: image height
</span>            <span class="n">w</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="n">net_w</span> <span class="c1"># unit: image width
</span>            <span class="n">h</span> <span class="o">=</span> <span class="n">anchors</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">net_h</span> <span class="c1"># unit: image height
</span>            <span class="c1"># last elements are class probabilities
</span>            <span class="n">classes</span> <span class="o">=</span> <span class="n">netout</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)][</span><span class="n">col</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="mi">5</span><span class="p">:]</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">BoundBox</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">objectness</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
            <span class="n">boxes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boxes</span>

<span class="k">def</span> <span class="nf">correct_yolo_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">image_h</span><span class="p">,</span> <span class="n">image_w</span><span class="p">,</span> <span class="n">net_h</span><span class="p">,</span> <span class="n">net_w</span><span class="p">):</span>
    <span class="n">new_w</span><span class="p">,</span> <span class="n">new_h</span> <span class="o">=</span> <span class="n">net_w</span><span class="p">,</span> <span class="n">net_h</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)):</span>
        <span class="n">x_offset</span><span class="p">,</span> <span class="n">x_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_w</span> <span class="o">-</span> <span class="n">new_w</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="o">/</span><span class="n">net_w</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_w</span><span class="p">)</span><span class="o">/</span><span class="n">net_w</span>
        <span class="n">y_offset</span><span class="p">,</span> <span class="n">y_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_h</span> <span class="o">-</span> <span class="n">new_h</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="o">/</span><span class="n">net_h</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_h</span><span class="p">)</span><span class="o">/</span><span class="n">net_h</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">x_offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_scale</span> <span class="o">*</span> <span class="n">image_w</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">x_offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_scale</span> <span class="o">*</span> <span class="n">image_w</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_scale</span> <span class="o">*</span> <span class="n">image_h</span><span class="p">)</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_scale</span> <span class="o">*</span> <span class="n">image_h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_interval_overlap</span><span class="p">(</span><span class="n">interval_a</span><span class="p">,</span> <span class="n">interval_b</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">interval_a</span>
    <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="n">interval_b</span>
    <span class="k">if</span> <span class="n">x3</span> <span class="o">&lt;</span> <span class="n">x1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x4</span> <span class="o">&lt;</span> <span class="n">x1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x4</span><span class="p">)</span> <span class="o">-</span> <span class="n">x1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">x3</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x4</span><span class="p">)</span> <span class="o">-</span> <span class="n">x3</span>

<span class="k">def</span> <span class="nf">bbox_iou</span><span class="p">(</span><span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">):</span>
    <span class="n">intersect_w</span> <span class="o">=</span> <span class="n">_interval_overlap</span><span class="p">([</span><span class="n">box1</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box1</span><span class="p">.</span><span class="n">xmax</span><span class="p">],</span> <span class="p">[</span><span class="n">box2</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box2</span><span class="p">.</span><span class="n">xmax</span><span class="p">])</span>
    <span class="n">intersect_h</span> <span class="o">=</span> <span class="n">_interval_overlap</span><span class="p">([</span><span class="n">box1</span><span class="p">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">box1</span><span class="p">.</span><span class="n">ymax</span><span class="p">],</span> <span class="p">[</span><span class="n">box2</span><span class="p">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">box2</span><span class="p">.</span><span class="n">ymax</span><span class="p">])</span>
    <span class="n">intersect</span> <span class="o">=</span> <span class="n">intersect_w</span> <span class="o">*</span> <span class="n">intersect_h</span>
    <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">box1</span><span class="p">.</span><span class="n">xmax</span><span class="o">-</span><span class="n">box1</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box1</span><span class="p">.</span><span class="n">ymax</span><span class="o">-</span><span class="n">box1</span><span class="p">.</span><span class="n">ymin</span>
    <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">box2</span><span class="p">.</span><span class="n">xmax</span><span class="o">-</span><span class="n">box2</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box2</span><span class="p">.</span><span class="n">ymax</span><span class="o">-</span><span class="n">box2</span><span class="p">.</span><span class="n">ymin</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">h1</span> <span class="o">+</span> <span class="n">w2</span><span class="o">*</span><span class="n">h2</span> <span class="o">-</span> <span class="n">intersect</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersect</span><span class="p">)</span> <span class="o">/</span> <span class="n">union</span>

<span class="k">def</span> <span class="nf">do_nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">nms_thresh</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nb_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">classes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_class</span><span class="p">):</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argsort</span><span class="p">([</span><span class="o">-</span><span class="n">box</span><span class="p">.</span><span class="n">classes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_indices</span><span class="p">)):</span>
            <span class="n">index_i</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">boxes</span><span class="p">[</span><span class="n">index_i</span><span class="p">].</span><span class="n">classes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_indices</span><span class="p">)):</span>
                <span class="n">index_j</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bbox_iou</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">index_i</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">index_j</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">nms_thresh</span><span class="p">:</span>
                    <span class="n">boxes</span><span class="p">[</span><span class="n">index_j</span><span class="p">].</span><span class="n">classes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># load and prepare an image
</span><span class="k">def</span> <span class="nf">load_image_pixels</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="c1"># load the image to get its shape
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span>
    <span class="c1"># load the image with the required size
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># convert to numpy array
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># scale pixel values to [0, 1]
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">/=</span> <span class="mf">255.0</span>
    <span class="c1"># add a dimension so that we have one sample
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>

<span class="c1"># get all of the results above a threshold
</span><span class="k">def</span> <span class="nf">get_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># enumerate all boxes
</span>    <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
        <span class="c1"># enumerate all possible labels
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
            <span class="c1"># check if the threshold for this label is high enough
</span>            <span class="k">if</span> <span class="n">box</span><span class="p">.</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">v_boxes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">v_labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">v_scores</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
                <span class="c1"># don't break, many labels may trigger for one box
</span>    <span class="k">return</span> <span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span>

<span class="c1"># draw all results
</span><span class="k">def</span> <span class="nf">draw_boxes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span><span class="p">):</span>
    <span class="c1"># load the image
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># plot the image
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># get the context for drawing boxes
</span>    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># plot each box
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_boxes</span><span class="p">)):</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">v_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># get coordinates
</span>        <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">ymax</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">xmax</span>
        <span class="c1"># calculate width and height of the box
</span>        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
        <span class="c1"># create the shape
</span>        <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'white'</span><span class="p">)</span>
        <span class="c1"># draw the box
</span>        <span class="n">ax</span><span class="p">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="c1"># draw text and score in top left corner
</span>        <span class="n">label</span> <span class="o">=</span> <span class="s">"%s (%.3f)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">v_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v_scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'white'</span><span class="p">)</span>
    <span class="c1"># show the plot
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="display-detection-results-for-example-image">Display detection results for example image</h3>
<p>The anchors defined in the code below are associated with the anchor boxes used in the YOLO networks.  These anchor boxes essentially define expected aspect ratios for objects in images and are used to “anchor” the detected bounding boxes.  The anchor boxes defined here are selected as good for the MSCOCO dataset.</p>

<p>There is also a <code class="language-plaintext highlighter-rouge">class_threshold</code> specified below.  This threshold changes the tolerance for accepting an object detection.  If we make this smaller, objects with less confidence will be included in the prediction.</p>

<p>There is additionally a threshold (the second parameters in the <code class="language-plaintext highlighter-rouge">do_nms</code> function call) for the non-maxima suppression of the boxes.  If we increase that value, we will find more overlapping (and potentially conflicting) bounding boxes in the prediction.</p>

<p>Finally, there are the list of 80 objects from the MSCOCO dataset which will be used to annotate the object detections on the image.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="c1"># load yolov3 model and perform object detection
</span>
<span class="c1"># load yolov3 model
</span><span class="n">model_yolo3</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s">'yolov3.h5'</span><span class="p">)</span>
<span class="c1"># define the expected input shape for the model
</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">=</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">416</span>
<span class="c1"># define our new photo
</span><span class="n">photo_filename</span> <span class="o">=</span> <span class="s">'zebra.jpg'</span>
<span class="c1"># load and prepare image
</span><span class="n">image</span><span class="p">,</span> <span class="n">image_w</span><span class="p">,</span> <span class="n">image_h</span> <span class="o">=</span> <span class="n">load_image_pixels</span><span class="p">(</span><span class="n">photo_filename</span><span class="p">,</span> <span class="p">(</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">))</span>
<span class="c1"># make prediction
</span><span class="n">yhat</span> <span class="o">=</span> <span class="n">model_yolo3</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="c1"># define the anchors
</span><span class="n">anchors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">116</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span><span class="mi">326</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span><span class="mi">119</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span><span class="mi">23</span><span class="p">]]</span>
<span class="c1"># define the probability threshold for detected objects
</span><span class="n">class_threshold</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">boxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">)):</span>
    <span class="c1"># decode the output of the network
</span>    <span class="n">boxes</span> <span class="o">+=</span> <span class="n">decode_netout</span><span class="p">(</span><span class="n">yhat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">class_threshold</span><span class="p">,</span> <span class="n">input_h</span><span class="p">,</span> <span class="n">input_w</span><span class="p">)</span>
<span class="c1"># correct the sizes of the bounding boxes for the shape of the image
</span><span class="n">correct_yolo_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">image_h</span><span class="p">,</span> <span class="n">image_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">,</span> <span class="n">input_w</span><span class="p">)</span>
<span class="c1"># suppress non-maximal boxes
</span><span class="n">do_nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="c1"># define the labels
</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s">"person"</span><span class="p">,</span> <span class="s">"bicycle"</span><span class="p">,</span> <span class="s">"car"</span><span class="p">,</span> <span class="s">"motorbike"</span><span class="p">,</span> <span class="s">"aeroplane"</span><span class="p">,</span> <span class="s">"bus"</span><span class="p">,</span> <span class="s">"train"</span><span class="p">,</span> <span class="s">"truck"</span><span class="p">,</span>
    <span class="s">"boat"</span><span class="p">,</span> <span class="s">"traffic light"</span><span class="p">,</span> <span class="s">"fire hydrant"</span><span class="p">,</span> <span class="s">"stop sign"</span><span class="p">,</span> <span class="s">"parking meter"</span><span class="p">,</span> <span class="s">"bench"</span><span class="p">,</span>
    <span class="s">"bird"</span><span class="p">,</span> <span class="s">"cat"</span><span class="p">,</span> <span class="s">"dog"</span><span class="p">,</span> <span class="s">"horse"</span><span class="p">,</span> <span class="s">"sheep"</span><span class="p">,</span> <span class="s">"cow"</span><span class="p">,</span> <span class="s">"elephant"</span><span class="p">,</span> <span class="s">"bear"</span><span class="p">,</span> <span class="s">"zebra"</span><span class="p">,</span> <span class="s">"giraffe"</span><span class="p">,</span>
    <span class="s">"backpack"</span><span class="p">,</span> <span class="s">"umbrella"</span><span class="p">,</span> <span class="s">"handbag"</span><span class="p">,</span> <span class="s">"tie"</span><span class="p">,</span> <span class="s">"suitcase"</span><span class="p">,</span> <span class="s">"frisbee"</span><span class="p">,</span> <span class="s">"skis"</span><span class="p">,</span> <span class="s">"snowboard"</span><span class="p">,</span>
    <span class="s">"sports ball"</span><span class="p">,</span> <span class="s">"kite"</span><span class="p">,</span> <span class="s">"baseball bat"</span><span class="p">,</span> <span class="s">"baseball glove"</span><span class="p">,</span> <span class="s">"skateboard"</span><span class="p">,</span> <span class="s">"surfboard"</span><span class="p">,</span>
    <span class="s">"tennis racket"</span><span class="p">,</span> <span class="s">"bottle"</span><span class="p">,</span> <span class="s">"wine glass"</span><span class="p">,</span> <span class="s">"cup"</span><span class="p">,</span> <span class="s">"fork"</span><span class="p">,</span> <span class="s">"knife"</span><span class="p">,</span> <span class="s">"spoon"</span><span class="p">,</span> <span class="s">"bowl"</span><span class="p">,</span> <span class="s">"banana"</span><span class="p">,</span>
    <span class="s">"apple"</span><span class="p">,</span> <span class="s">"sandwich"</span><span class="p">,</span> <span class="s">"orange"</span><span class="p">,</span> <span class="s">"broccoli"</span><span class="p">,</span> <span class="s">"carrot"</span><span class="p">,</span> <span class="s">"hot dog"</span><span class="p">,</span> <span class="s">"pizza"</span><span class="p">,</span> <span class="s">"donut"</span><span class="p">,</span> <span class="s">"cake"</span><span class="p">,</span>
    <span class="s">"chair"</span><span class="p">,</span> <span class="s">"sofa"</span><span class="p">,</span> <span class="s">"pottedplant"</span><span class="p">,</span> <span class="s">"bed"</span><span class="p">,</span> <span class="s">"diningtable"</span><span class="p">,</span> <span class="s">"toilet"</span><span class="p">,</span> <span class="s">"tvmonitor"</span><span class="p">,</span> <span class="s">"laptop"</span><span class="p">,</span> <span class="s">"mouse"</span><span class="p">,</span>
    <span class="s">"remote"</span><span class="p">,</span> <span class="s">"keyboard"</span><span class="p">,</span> <span class="s">"cell phone"</span><span class="p">,</span> <span class="s">"microwave"</span><span class="p">,</span> <span class="s">"oven"</span><span class="p">,</span> <span class="s">"toaster"</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">,</span> <span class="s">"refrigerator"</span><span class="p">,</span>
    <span class="s">"book"</span><span class="p">,</span> <span class="s">"clock"</span><span class="p">,</span> <span class="s">"vase"</span><span class="p">,</span> <span class="s">"scissors"</span><span class="p">,</span> <span class="s">"teddy bear"</span><span class="p">,</span> <span class="s">"hair drier"</span><span class="p">,</span> <span class="s">"toothbrush"</span><span class="p">]</span>
<span class="c1"># get the details of the detected objects
</span><span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span> <span class="o">=</span> <span class="n">get_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">class_threshold</span><span class="p">)</span>
<span class="c1"># summarize what we found
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_boxes</span><span class="p">)):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v_scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="c1"># draw what we found
</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">photo_filename</span><span class="p">,</span> <span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-your-turn-"><strong><span style="color:Green"> Your turn: </span></strong></h2>
<p>Modify the code above to see how the network behaves on different images, or with different paramter choices, especially for the <code class="language-plaintext highlighter-rouge">class_threshold</code> or the <code class="language-plaintext highlighter-rouge">do_nms</code> threshold.  For your convenience, the code from the cell above has been copied down below for you to modify.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from https://machinelearningmastery.com/how-to-perform-object-detection-with-yolov3-in-keras/
# which based the code on https://github.com/experiencor/keras-yolo3 (see MIT License statement above)
</span>
<span class="c1"># load yolov3 model and perform object detection
</span>
<span class="c1"># load yolov3 model
</span><span class="n">model_yolo3</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s">'yolov3.h5'</span><span class="p">)</span>
<span class="c1"># define the expected input shape for the model
</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span> <span class="o">=</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">416</span>
<span class="c1"># define our new photo
</span><span class="n">photo_filename</span> <span class="o">=</span> <span class="s">'zebra.jpg'</span>
<span class="c1"># load and prepare image
</span><span class="n">image</span><span class="p">,</span> <span class="n">image_w</span><span class="p">,</span> <span class="n">image_h</span> <span class="o">=</span> <span class="n">load_image_pixels</span><span class="p">(</span><span class="n">photo_filename</span><span class="p">,</span> <span class="p">(</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">))</span>
<span class="c1"># make prediction
</span><span class="n">yhat</span> <span class="o">=</span> <span class="n">model_yolo3</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="c1"># define the anchors
</span><span class="n">anchors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">116</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span><span class="mi">198</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span><span class="mi">326</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span><span class="mi">119</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span><span class="mi">23</span><span class="p">]]</span>
<span class="c1"># define the probability threshold for detected objects
</span><span class="n">class_threshold</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">boxes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">)):</span>
    <span class="c1"># decode the output of the network
</span>    <span class="n">boxes</span> <span class="o">+=</span> <span class="n">decode_netout</span><span class="p">(</span><span class="n">yhat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">class_threshold</span><span class="p">,</span> <span class="n">input_h</span><span class="p">,</span> <span class="n">input_w</span><span class="p">)</span>
<span class="c1"># correct the sizes of the bounding boxes for the shape of the image
</span><span class="n">correct_yolo_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">image_h</span><span class="p">,</span> <span class="n">image_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">,</span> <span class="n">input_w</span><span class="p">)</span>
<span class="c1"># suppress non-maximal boxes
</span><span class="n">do_nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="c1"># define the labels
</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s">"person"</span><span class="p">,</span> <span class="s">"bicycle"</span><span class="p">,</span> <span class="s">"car"</span><span class="p">,</span> <span class="s">"motorbike"</span><span class="p">,</span> <span class="s">"aeroplane"</span><span class="p">,</span> <span class="s">"bus"</span><span class="p">,</span> <span class="s">"train"</span><span class="p">,</span> <span class="s">"truck"</span><span class="p">,</span>
    <span class="s">"boat"</span><span class="p">,</span> <span class="s">"traffic light"</span><span class="p">,</span> <span class="s">"fire hydrant"</span><span class="p">,</span> <span class="s">"stop sign"</span><span class="p">,</span> <span class="s">"parking meter"</span><span class="p">,</span> <span class="s">"bench"</span><span class="p">,</span>
    <span class="s">"bird"</span><span class="p">,</span> <span class="s">"cat"</span><span class="p">,</span> <span class="s">"dog"</span><span class="p">,</span> <span class="s">"horse"</span><span class="p">,</span> <span class="s">"sheep"</span><span class="p">,</span> <span class="s">"cow"</span><span class="p">,</span> <span class="s">"elephant"</span><span class="p">,</span> <span class="s">"bear"</span><span class="p">,</span> <span class="s">"zebra"</span><span class="p">,</span> <span class="s">"giraffe"</span><span class="p">,</span>
    <span class="s">"backpack"</span><span class="p">,</span> <span class="s">"umbrella"</span><span class="p">,</span> <span class="s">"handbag"</span><span class="p">,</span> <span class="s">"tie"</span><span class="p">,</span> <span class="s">"suitcase"</span><span class="p">,</span> <span class="s">"frisbee"</span><span class="p">,</span> <span class="s">"skis"</span><span class="p">,</span> <span class="s">"snowboard"</span><span class="p">,</span>
    <span class="s">"sports ball"</span><span class="p">,</span> <span class="s">"kite"</span><span class="p">,</span> <span class="s">"baseball bat"</span><span class="p">,</span> <span class="s">"baseball glove"</span><span class="p">,</span> <span class="s">"skateboard"</span><span class="p">,</span> <span class="s">"surfboard"</span><span class="p">,</span>
    <span class="s">"tennis racket"</span><span class="p">,</span> <span class="s">"bottle"</span><span class="p">,</span> <span class="s">"wine glass"</span><span class="p">,</span> <span class="s">"cup"</span><span class="p">,</span> <span class="s">"fork"</span><span class="p">,</span> <span class="s">"knife"</span><span class="p">,</span> <span class="s">"spoon"</span><span class="p">,</span> <span class="s">"bowl"</span><span class="p">,</span> <span class="s">"banana"</span><span class="p">,</span>
    <span class="s">"apple"</span><span class="p">,</span> <span class="s">"sandwich"</span><span class="p">,</span> <span class="s">"orange"</span><span class="p">,</span> <span class="s">"broccoli"</span><span class="p">,</span> <span class="s">"carrot"</span><span class="p">,</span> <span class="s">"hot dog"</span><span class="p">,</span> <span class="s">"pizza"</span><span class="p">,</span> <span class="s">"donut"</span><span class="p">,</span> <span class="s">"cake"</span><span class="p">,</span>
    <span class="s">"chair"</span><span class="p">,</span> <span class="s">"sofa"</span><span class="p">,</span> <span class="s">"pottedplant"</span><span class="p">,</span> <span class="s">"bed"</span><span class="p">,</span> <span class="s">"diningtable"</span><span class="p">,</span> <span class="s">"toilet"</span><span class="p">,</span> <span class="s">"tvmonitor"</span><span class="p">,</span> <span class="s">"laptop"</span><span class="p">,</span> <span class="s">"mouse"</span><span class="p">,</span>
    <span class="s">"remote"</span><span class="p">,</span> <span class="s">"keyboard"</span><span class="p">,</span> <span class="s">"cell phone"</span><span class="p">,</span> <span class="s">"microwave"</span><span class="p">,</span> <span class="s">"oven"</span><span class="p">,</span> <span class="s">"toaster"</span><span class="p">,</span> <span class="s">"sink"</span><span class="p">,</span> <span class="s">"refrigerator"</span><span class="p">,</span>
    <span class="s">"book"</span><span class="p">,</span> <span class="s">"clock"</span><span class="p">,</span> <span class="s">"vase"</span><span class="p">,</span> <span class="s">"scissors"</span><span class="p">,</span> <span class="s">"teddy bear"</span><span class="p">,</span> <span class="s">"hair drier"</span><span class="p">,</span> <span class="s">"toothbrush"</span><span class="p">]</span>
<span class="c1"># get the details of the detected objects
</span><span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span> <span class="o">=</span> <span class="n">get_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">class_threshold</span><span class="p">)</span>
<span class="c1"># summarize what we found
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_boxes</span><span class="p">)):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v_scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="c1"># draw what we found
</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">photo_filename</span><span class="p">,</span> <span class="n">v_boxes</span><span class="p">,</span> <span class="n">v_labels</span><span class="p">,</span> <span class="n">v_scores</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="section-2-mask-rcnn-for-object-segmentation">Section 2 Mask-RCNN for Object Segmentation</h1>

<p>In this section, we look at the use of the Mask-RCNN network for delineation of objects in images.  The Mask-RCNN paper can be found here: https://arxiv.org/pdf/1703.06870.pdf</p>

<p>The code in this section The code in this section was taken and modified (slightly) from: https://machinelearningmastery.com/how-to-perform-object-detection-in-photographs-with-mask-r-cnn-in-keras/</p>

<p>This code took some extra work to get installed and working on my machine.  I include below some tips for other users, but note that this may be very specific to your OS and/or to your tensorflow version.  Some of these steps are from the url above, but some are gathered from my own experience.</p>

<p><strong>Step 1</strong>: In the desired directory on your machine, donwload the Mask-RCNN implemented by matterport with the following command typed at your command prompt:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/matterport/Mask_RCNN.git
</code></pre></div></div>
<p>This download is about 125 MB.  The Matterport code is covered by an MIT License, copied below as reference.</p>

<p><strong>Step 2</strong>: Create a conda environment to make sure that any subsequent installs for the Mask-RCNN do not interfere with any existing installs.  From your command prompt or conda terminal, type:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda create -n mask_rcnn
</code></pre></div></div>
<p>This will install a conda environment called <code class="language-plaintext highlighter-rouge">mask_rcnn</code>.  You can choose any other name you desire.</p>

<p><strong>Step 3</strong>: Activate your new conda environment by typing the following from your command prompt or conda terminal:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda activate mask_rcnn
</code></pre></div></div>

<p><strong>Step 4</strong>: Install pip in your conda environment by typing the following from your command prompt or conda terminal:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda install pip
</code></pre></div></div>

<p><strong>Step5</strong>: Navigate to the <code class="language-plaintext highlighter-rouge">Mask_RCNN</code> directory created by the git download and then run the following from your command prompt or conda terminal:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python setup.py install
</code></pre></div></div>
<p>If this command runs successfully, you should see the following message at the end of the setup process.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Finished processing dependencies for mask-rcnn==2.1
</code></pre></div></div>
<p>If you run the following command,</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip show mask-rcn
</code></pre></div></div>
<p>you should get an output similar to the following as yet another indication of a successful install.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name: mask-rcnn
Version: 2.1
Summary: Mask R-CNN for object detection and instance segmentation
Home-page: https://github.com/matterport/Mask_RCNN
Author: Matterport
Author-email: waleed.abdulla@gmail.com
License: MIT
Location: /home/lboucher/anaconda3/envs/mask_rcnn/lib/python3.8/site-packages/mask_rcnn-2.1-py3.8.egg
Requires:
Required-by:
</code></pre></div></div>

<p><strong>Step 6</strong>: Download the Mask RCNN weights trained on the MSCOCO dataset from https://github.com/matterport/Mask_RCNN/releases/download/v2.0/mask_rcnn_coco.h5.  This download is 246 MB.</p>

<p><strong>Step 7</strong>: (the really fun step) Unless you happend to be running <em>exactly</em> the right tensorflow version, you will get a bunch of errors when running one or more of the code cells below.  I was able to get this code working with my version of tensorflow (2.1.0) by very carefully changing individual lines of code in the <code class="language-plaintext highlighter-rouge">Mask_RCNN/mrcnn/model.py</code> code.  I changed these lines one by one as I encountered errors.  All of these errors had to do with deprecated syntax in tensorflow.  I needed to change all instances of the following (your mileage may vary depending on your version of tensorflow):</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">tf.log</code> -&gt; <code class="language-plaintext highlighter-rouge">tf.math.log</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.sets.set_intersection</code> -&gt; <code class="language-plaintext highlighter-rouge">tf.sets.intersection</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.sparse_tensor_to_dense</code> -&gt; <code class="language-plaintext highlighter-rouge">tf.sparse_to_dense</code></li>
  <li><code class="language-plaintext highlighter-rouge">tf.to_float</code> -&gt; <code class="language-plaintext highlighter-rouge">tf.cast(...,tf.float32)</code>
It is also important to note that you need to be very careful to actually reload the mrcnn module after each change to <code class="language-plaintext highlighter-rouge">Mask_RCNN/mrcnn/model.py</code> code.</li>
</ul>

<p>License information for the matterport Mask-RCNN code at https://github.com/matterport/Mask_RCNN:</p>

<p>Mask R-CNN</p>

<p>The MIT License (MIT)</p>

<p>Copyright (c) 2017 Matterport, Inc.</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the “Software”), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>

<h3 id="detect-an-object-in-an-image-and-visualize-the-segmentation-mask">Detect an object in an image and visualize the segmentation mask</h3>
<p>The code below loads in an example image <code class="language-plaintext highlighter-rouge">elephant.jpg</code> available from https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2019/03/elephant.jpg, and sends the image through the Mask-RCNN network.  The following class <code class="language-plaintext highlighter-rouge">TestConfig</code> is used as part of the configuration of the <code class="language-plaintext highlighter-rouge">MaskRCNN</code> class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/how-to-perform-object-detection-in-photographs-with-mask-r-cnn-in-keras/
</span>
<span class="c1"># define the test configuration
</span><span class="k">class</span> <span class="nc">TestConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="s">"test"</span>
    <span class="n">GPU_COUNT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IMAGES_PER_GPU</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">80</span>
</code></pre></div></div>

<p>The code below uses a list of the MSCOCO labels similar to the example in Section 1, but includes an 81st label for background <code class="language-plaintext highlighter-rouge">'BG'</code>.</p>

<p>The code below additionally uses a method <code class="language-plaintext highlighter-rouge">display_instances</code> included as part of the <code class="language-plaintext highlighter-rouge">MaskRCNN</code> class defined as part of the software we downloaded.  This <code class="language-plaintext highlighter-rouge">display_instances</code> code will interpret the output form the Mask-RCNN network and visualize the object detection.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/how-to-perform-object-detection-in-photographs-with-mask-r-cnn-in-keras/
</span>
<span class="c1"># example of inference with a pre-trained coco model
</span>
<span class="c1"># define 81 classes that the coco model knowns about
</span><span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'BG'</span><span class="p">,</span> <span class="s">'person'</span><span class="p">,</span> <span class="s">'bicycle'</span><span class="p">,</span> <span class="s">'car'</span><span class="p">,</span> <span class="s">'motorcycle'</span><span class="p">,</span> <span class="s">'airplane'</span><span class="p">,</span>
               <span class="s">'bus'</span><span class="p">,</span> <span class="s">'train'</span><span class="p">,</span> <span class="s">'truck'</span><span class="p">,</span> <span class="s">'boat'</span><span class="p">,</span> <span class="s">'traffic light'</span><span class="p">,</span>
               <span class="s">'fire hydrant'</span><span class="p">,</span> <span class="s">'stop sign'</span><span class="p">,</span> <span class="s">'parking meter'</span><span class="p">,</span> <span class="s">'bench'</span><span class="p">,</span> <span class="s">'bird'</span><span class="p">,</span>
               <span class="s">'cat'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">,</span> <span class="s">'horse'</span><span class="p">,</span> <span class="s">'sheep'</span><span class="p">,</span> <span class="s">'cow'</span><span class="p">,</span> <span class="s">'elephant'</span><span class="p">,</span> <span class="s">'bear'</span><span class="p">,</span>
               <span class="s">'zebra'</span><span class="p">,</span> <span class="s">'giraffe'</span><span class="p">,</span> <span class="s">'backpack'</span><span class="p">,</span> <span class="s">'umbrella'</span><span class="p">,</span> <span class="s">'handbag'</span><span class="p">,</span> <span class="s">'tie'</span><span class="p">,</span>
               <span class="s">'suitcase'</span><span class="p">,</span> <span class="s">'frisbee'</span><span class="p">,</span> <span class="s">'skis'</span><span class="p">,</span> <span class="s">'snowboard'</span><span class="p">,</span> <span class="s">'sports ball'</span><span class="p">,</span>
               <span class="s">'kite'</span><span class="p">,</span> <span class="s">'baseball bat'</span><span class="p">,</span> <span class="s">'baseball glove'</span><span class="p">,</span> <span class="s">'skateboard'</span><span class="p">,</span>
               <span class="s">'surfboard'</span><span class="p">,</span> <span class="s">'tennis racket'</span><span class="p">,</span> <span class="s">'bottle'</span><span class="p">,</span> <span class="s">'wine glass'</span><span class="p">,</span> <span class="s">'cup'</span><span class="p">,</span>
               <span class="s">'fork'</span><span class="p">,</span> <span class="s">'knife'</span><span class="p">,</span> <span class="s">'spoon'</span><span class="p">,</span> <span class="s">'bowl'</span><span class="p">,</span> <span class="s">'banana'</span><span class="p">,</span> <span class="s">'apple'</span><span class="p">,</span>
               <span class="s">'sandwich'</span><span class="p">,</span> <span class="s">'orange'</span><span class="p">,</span> <span class="s">'broccoli'</span><span class="p">,</span> <span class="s">'carrot'</span><span class="p">,</span> <span class="s">'hot dog'</span><span class="p">,</span> <span class="s">'pizza'</span><span class="p">,</span>
               <span class="s">'donut'</span><span class="p">,</span> <span class="s">'cake'</span><span class="p">,</span> <span class="s">'chair'</span><span class="p">,</span> <span class="s">'couch'</span><span class="p">,</span> <span class="s">'potted plant'</span><span class="p">,</span> <span class="s">'bed'</span><span class="p">,</span>
               <span class="s">'dining table'</span><span class="p">,</span> <span class="s">'toilet'</span><span class="p">,</span> <span class="s">'tv'</span><span class="p">,</span> <span class="s">'laptop'</span><span class="p">,</span> <span class="s">'mouse'</span><span class="p">,</span> <span class="s">'remote'</span><span class="p">,</span>
               <span class="s">'keyboard'</span><span class="p">,</span> <span class="s">'cell phone'</span><span class="p">,</span> <span class="s">'microwave'</span><span class="p">,</span> <span class="s">'oven'</span><span class="p">,</span> <span class="s">'toaster'</span><span class="p">,</span>
               <span class="s">'sink'</span><span class="p">,</span> <span class="s">'refrigerator'</span><span class="p">,</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'clock'</span><span class="p">,</span> <span class="s">'vase'</span><span class="p">,</span> <span class="s">'scissors'</span><span class="p">,</span>
               <span class="s">'teddy bear'</span><span class="p">,</span> <span class="s">'hair drier'</span><span class="p">,</span> <span class="s">'toothbrush'</span><span class="p">]</span>


<span class="c1"># define the model
</span><span class="n">rcnn</span> <span class="o">=</span> <span class="n">MaskRCNN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">'inference'</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="s">'./'</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">TestConfig</span><span class="p">())</span>
<span class="c1"># load coco model weights
</span><span class="n">rcnn</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s">'mask_rcnn_coco.h5'</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># load photograph
</span><span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="s">'elephant.jpg'</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># make prediction
</span><span class="n">results</span> <span class="o">=</span> <span class="n">rcnn</span><span class="p">.</span><span class="n">detect</span><span class="p">([</span><span class="n">img</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># get dictionary for first prediction
</span><span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># show photo with bounding boxes, masks, class labels and scores
</span><span class="n">display_instances</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">'rois'</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">'masks'</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">'class_ids'</span><span class="p">],</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">'scores'</span><span class="p">])</span>
</code></pre></div></div>

<p>We see that the Mask-RCNN has detected the elephant in the image and outlined it with a bounding box and a confidence score.  It also visualizes the segmentation mask overlying the detected object.</p>

<p>We note here that, unfortunately, the MaskRCNN class provided as part of the downloaded software does not appear to include a summary method to display the characteristics of the network.  We would need to read through the code in the <code class="language-plaintext highlighter-rouge">Mask_RCNN/mrcnn/model.py</code> file to determine more details about the network.</p>

<p>We also notice that many of the potentially tuneable parameters are not as obvious in the code.  They may be options available in the <code class="language-plaintext highlighter-rouge">MaskRCNN</code> class, or it might require modification of the underlying python code.</p>

<h3 id="modify-the-code-to-outline-multiple-objects">Modify the code to outline multiple objects</h3>
<p>In the code below, instead of using only the first prediction, we loop over all the predictions and label each separately.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/how-to-perform-object-detection-in-photographs-with-mask-r-cnn-in-keras/
</span>
<span class="c1"># define the model
</span><span class="n">rcnn</span> <span class="o">=</span> <span class="n">MaskRCNN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">'inference'</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="s">'./'</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">TestConfig</span><span class="p">())</span>
<span class="c1"># load coco model weights
</span><span class="n">rcnn</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s">'mask_rcnn_coco.h5'</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># load photograph
</span><span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="s">'zebra.jpg'</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># make prediction
</span><span class="n">results</span> <span class="o">=</span> <span class="n">rcnn</span><span class="p">.</span><span class="n">detect</span><span class="p">([</span><span class="n">img</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># plot all prediction results
</span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="c1"># show photo with bounding boxes, masks, class labels and scores
</span>    <span class="n">display_instances</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">'rois'</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">'masks'</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">'class_ids'</span><span class="p">],</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">'scores'</span><span class="p">])</span>
</code></pre></div></div>

<h2 id="-your-turn--1"><strong><span style="color:Green"> Your turn: </span></strong></h2>
<p>Modify the code above to see how the network behaves on different images.  For your convenience, the code from the cell above has been copied down below for you to modify.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/how-to-perform-object-detection-in-photographs-with-mask-r-cnn-in-keras/
</span>
<span class="c1"># define the model
</span><span class="n">rcnn</span> <span class="o">=</span> <span class="n">MaskRCNN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">'inference'</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="s">'./'</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">TestConfig</span><span class="p">())</span>
<span class="c1"># load coco model weights
</span><span class="n">rcnn</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s">'mask_rcnn_coco.h5'</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># load photograph
</span><span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="s">'zebra.jpg'</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># make prediction
</span><span class="n">results</span> <span class="o">=</span> <span class="n">rcnn</span><span class="p">.</span><span class="n">detect</span><span class="p">([</span><span class="n">img</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># plot all prediction results
</span><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="c1"># show photo with bounding boxes, masks, class labels and scores
</span>    <span class="n">display_instances</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">'rois'</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">'masks'</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">'class_ids'</span><span class="p">],</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">'scores'</span><span class="p">])</span>
</code></pre></div></div>

<h1 id="section-3-time-series-prediction-with-an-lstm">Section 3: Time Series Prediction with an LSTM</h1>

<p>In this section, we look at the use of an LSTM (Long Short-Term Memory) network for time-series prediction.  LSTMs are a form of Recurrent Neural Networks (RNNs) that can learn from temporal sequences of data.</p>

<p>This example has been adapted from https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/ and will use a small dataset consisting of the number of airline passengers each month from January 1949 to December 1960.  The dataset can be downloaded from: https://raw.githubusercontent.com/jbrownlee/Datasets/master/airline-passengers.csv.  Note that although the url specifies that this is a <code class="language-plaintext highlighter-rouge">.csv</code> file, it is actually a <code class="language-plaintext highlighter-rouge">.txt</code> file.</p>

<p>The ultimate goal will be, given some amount of “history” in this data to predict the “future” demand.</p>

<h3 id="set-random-seed">Set random seed</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/
# fix random seed for reproducibility
</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="take-a-quick-look-at-this-data">Take a quick look at this data</h3>
<p>In the following code, the first column of the data (the date) is discarded since all the data are evenly spaced one month apart.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/
# load the dataset
</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'airline-passengers.txt'</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s">'python'</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">.</span><span class="n">values</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="normalize-the-dataset-and-split-into-train-and-test-sets">Normalize the dataset and split into train and test sets</h3>
<p>The following code uses the <code class="language-plaintext highlighter-rouge">MinMaxScaler</code> function from <code class="language-plaintext highlighter-rouge">sklearn.preprocessing</code> to normalize the data to the range [0,1].  The first two thirds of the dataset is set aside for training (the history) and the last third will be used to compare to the model prediction.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/
# normalize the dataset
</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="c1"># split into train and test sets
</span><span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.67</span><span class="p">)</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">train_size</span><span class="p">,:],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),:]</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="define-function-to-rearrange-data">Define function to rearrange data</h3>
<p>The following function rearranges the time series data into windows of data of length <code class="language-plaintext highlighter-rouge">look_back</code> which are used to predict the subsequent value.  This function is defined to be general so that we can use it for any length of <code class="language-plaintext highlighter-rouge">look_back</code> windows.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the following code adapted from
# https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/
# convert an array of values into a dataset matrix
</span><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">look_back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">dataX</span><span class="p">,</span> <span class="n">dataY</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="n">look_back</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="n">look_back</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">dataX</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">dataY</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">look_back</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataX</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataY</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="define-data-for-a-look-back-window-of-1-sample">Define data for a look-back window of 1 sample</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># reshape into X=t and Y=t+1
</span><span class="n">look_back</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)</span>
<span class="n">testX</span><span class="p">,</span> <span class="n">testY</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-your-turn--2"><strong><span style="color:Green"> Your turn: </span></strong></h2>
<p>Explore the contents of the training and test data.  It might be helpful to open the <code class="language-plaintext highlighter-rouge">airline-passengers.txt</code> file in a text editor to see how it the <code class="language-plaintext highlighter-rouge">trainX</code>, <code class="language-plaintext highlighter-rouge">trainY</code>, <code class="language-plaintext highlighter-rouge">testX</code>, and <code class="language-plaintext highlighter-rouge">testY</code> variable relate to the original data.  Remember, however, that the data has been normalized to the range [0,1].  We can use the <code class="language-plaintext highlighter-rouge">scaler.inverse_transform</code> method to reverse the scaling.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="wrangle-tensor-dimensionality">Wrangle tensor dimensionality</h3>
<p>The LSTM will expect input to be in the form samples$\times$look-back$\times$features.  Samples is the number of example sequences we have, look-back is the number of time steps in each of those sequences, and features are the actual times sequences.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># reshape input to be [samples, time steps, features]
</span><span class="n">trainX</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="p">(</span><span class="n">trainX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trainX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">testX</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="p">(</span><span class="n">testX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">testX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div></div>

<h2 id="-your-turn--3"><strong><span style="color:Green"> Your turn: </span></strong></h2>
<p>Explore the dimensionality and/or contents of the training and test data now.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="important-note-about-re-running-individual-code-blocks">Important note about re-running individual code blocks</h3>
<p>If you re-run individual code blocks up above, you may inadvertently duplicate reshaping, etc.  If you end up with dimensionality errors below, start back up at the beginning of this section and run the code cells in sequence again.  After we finish this example, the entire code will be copied into a single code cell to avoid these duplication issues.</p>

<h3 id="define-the-lstm-and-fit-to-the-training-data">Define the LSTM and fit to the training data</h3>
<p>The network defined below is very small–one hidden layer consisting of four LSTM neurons.  Note that since this is a problem of regression (predicting a continuous-valued output rather than a category), the loss is <code class="language-plaintext highlighter-rouge">'mean_squared_error'</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create and fit the LSTM network
</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'mean_squared_error'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="predict-the-rest-of-the-time-sequence">Predict the rest of the time sequence</h3>
<p>Now that the LSTM is trained, we can use it to predict the rest of the sequence.  Remember that the network has not seen any of the data from the last third of the sequence.  We also use it to predict the first two thirds of the sequence, expecting that there is likely some small deviation due to model errors.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># make predictions
</span><span class="n">trainPredict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">trainX</span><span class="p">)</span>
<span class="n">testPredict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">testX</span><span class="p">)</span>
<span class="c1"># invert predictions
</span><span class="n">trainPredict</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">trainPredict</span><span class="p">)</span>
<span class="n">trainY</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">([</span><span class="n">trainY</span><span class="p">])</span>
<span class="n">testPredict</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">testPredict</span><span class="p">)</span>
<span class="n">testY</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">([</span><span class="n">testY</span><span class="p">])</span>
<span class="c1"># calculate root mean squared error
</span><span class="n">trainScore</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">trainY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trainPredict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Train Score: %.2f RMSE'</span> <span class="o">%</span> <span class="p">(</span><span class="n">trainScore</span><span class="p">))</span>
<span class="n">testScore</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">testY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">testPredict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test Score: %.2f RMSE'</span> <span class="o">%</span> <span class="p">(</span><span class="n">testScore</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="plot-and-compare-the-prediction-to-truth">Plot and compare the prediction to truth</h3>
<p>Some care needs to be taken in plotting the predicted sequences since there is a window of values before the network can make a prediction.  This means that the predicted sequence for train and for test is slightly shorter than the original train and test sequences.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># shift train predictions for plotting
</span><span class="n">trainPredictPlot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">trainPredictPlot</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
<span class="n">trainPredictPlot</span><span class="p">[</span><span class="n">look_back</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">trainPredict</span><span class="p">)</span><span class="o">+</span><span class="n">look_back</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">trainPredict</span>
<span class="c1"># shift test predictions for plotting
</span><span class="n">testPredictPlot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">testPredictPlot</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
<span class="n">testPredictPlot</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trainPredict</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">look_back</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">testPredict</span>
<span class="c1"># plot baseline and predictions
</span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trainPredictPlot</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">testPredictPlot</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="-your-turn--4"><strong><span style="color:Green"> Your turn: </span></strong></h2>
<p>Try choosing a different look-back window and see the effects on the prediction.  You can also try changing the architecture of the LSTM if you wish.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fix random seed for reproducibility
</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="c1"># load the dataset
</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'airline-passengers.txt'</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s">'python'</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">.</span><span class="n">values</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="c1"># normalize the dataset
</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="c1"># split into train and test sets
</span><span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.67</span><span class="p">)</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">train_size</span><span class="p">,:],</span> <span class="n">dataset</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),:]</span>
<span class="c1"># reshape into X=t and Y=t+1
</span><span class="n">look_back</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)</span>
<span class="n">testX</span><span class="p">,</span> <span class="n">testY</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)</span>
<span class="c1"># reshape input to be [samples, time steps, features]
</span><span class="n">trainX</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="p">(</span><span class="n">trainX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trainX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">testX</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">testX</span><span class="p">,</span> <span class="p">(</span><span class="n">testX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">testX</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="c1"># create and fit the LSTM network
</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">look_back</span><span class="p">)))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'mean_squared_error'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainX</span><span class="p">,</span> <span class="n">trainY</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># make predictions
</span><span class="n">trainPredict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">trainX</span><span class="p">)</span>
<span class="n">testPredict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">testX</span><span class="p">)</span>
<span class="c1"># invert predictions
</span><span class="n">trainPredict</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">trainPredict</span><span class="p">)</span>
<span class="n">trainY</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">([</span><span class="n">trainY</span><span class="p">])</span>
<span class="n">testPredict</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">testPredict</span><span class="p">)</span>
<span class="n">testY</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">([</span><span class="n">testY</span><span class="p">])</span>
<span class="c1"># calculate root mean squared error
</span><span class="n">trainScore</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">trainY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trainPredict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Train Score: %.2f RMSE'</span> <span class="o">%</span> <span class="p">(</span><span class="n">trainScore</span><span class="p">))</span>
<span class="n">testScore</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">testY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">testPredict</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test Score: %.2f RMSE'</span> <span class="o">%</span> <span class="p">(</span><span class="n">testScore</span><span class="p">))</span>
<span class="c1"># shift train predictions for plotting
</span><span class="n">trainPredictPlot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">trainPredictPlot</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
<span class="n">trainPredictPlot</span><span class="p">[</span><span class="n">look_back</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">trainPredict</span><span class="p">)</span><span class="o">+</span><span class="n">look_back</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">trainPredict</span>
<span class="c1"># shift test predictions for plotting
</span><span class="n">testPredictPlot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">testPredictPlot</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
<span class="n">testPredictPlot</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">trainPredict</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">look_back</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">testPredict</span>
<span class="c1"># plot baseline and predictions
</span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scaler</span><span class="p">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trainPredictPlot</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">testPredictPlot</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="food-for-thought">Food for thought:</h1>
<p>How might you somehow combine the capabilities of a CNN or classical machine learning for image analysis with an LSTM for sequence analysis to be able to analyze spatiotemporal information?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      

    </div>

    
  </article>

  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id">
    <input type="search" id="cse-search-input-box-id" aria-placeholder="Enter your search term..." class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    </form>
    <div id="results" class="results">
        <gcse:searchresults-only></gcse:searchresults-only>
    </div></div>

      </div>
    
    
    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/isugif"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="https://github.com/https://github.com/isugenomics"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Geospatial Workbook</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>


<script>
  (function () {
    var cx = '009853197685285203469:nsvri1pa88d';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
</script>




<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" defer
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>




  </body>
</html>
