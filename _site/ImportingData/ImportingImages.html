<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.2 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Importing Data From Santeniel 2 Satellite - Geospatial Workbook</title>
<meta name="description" content="Tutorial on Informatics for Geospatial Information">


  <meta name="author" content="Rowan Gaffney">


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Geospatial Workbook">
<meta property="og:title" content="Importing Data From Santeniel 2 Satellite">
<meta property="og:url" content="http://localhost:4000/ImportingData/ImportingImages.html">




  <meta property="og:image" content="http://localhost:4000/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg">



  <meta name="twitter:site" content="@isugif">
  <meta name="twitter:title" content="Importing Data From Santeniel 2 Satellite">
  <meta name="twitter:description" content="Tutorial on Informatics for Geospatial Information">
  <meta name="twitter:url" content="http://localhost:4000/ImportingData/ImportingImages.html">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg">
  

  
    <meta name="twitter:creator" content="@someone">
  







  

  


<link rel="canonical" href="http://localhost:4000/ImportingData/ImportingImages.html">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Geospatial Workbook Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E6BZVYF8ZY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E6BZVYF8ZY');
</script>

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Geospatial Workbook</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about.html" >About</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/list.html" >Index</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/glossary.html" >Glossary</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/people.html" >People</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/contributing.html" >Contribute</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style="background-color: 444444; background-image: url('/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Importing Data From Santeniel 2 Satellite

        
      </h1>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/people/RowanGaffney.jpg" alt="Rowan Gaffney" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Rowan Gaffney</h3>
    
    
      <p class="author__bio" itemprop="description">
        Rowan is a physical scientist in the Rangeland Resource & Systems Research Unit in Fort Collins, CO. He specializes in analyzing large, multidimensional geospatial data using a variety of approaches from machine learning to numerical analysis.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      
        <li>
          <a href="mailto:mailto:rowan.gaffney@usda.gov">
            <meta itemprop="email" content="mailto:rowan.gaffney@usda.gov" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/someone" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/https://github.com/rmg55" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

<!-- Create a 2nd author for tutorials -->



<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Importing Data From Santeniel 2 Satellite">
    
    
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Last Update:</strong> 13 April 2021 <br />
<strong>Download Jupyter Notebook</strong>: <a href="https://geospatial.101workbook.org/tutorials/Sentinel2_STAC.ipynb">Sentinel2_STAC.ipynb</a></p>

<p>This tutorial can be run with Binder, via <a href="https://mybinder.readthedocs.io/en/latest/">MyBinder</a> (free service hosted on Google Cloud). <!-- , or it can be run on the [USDA ARS Ceres HPC](https://scinet.usda.gov/guide/jupyter/) using the JupyterHub service (SCINet credentials are required). --></p>

<p><a href="https://mybinder.org/v2/gh/ISUgenomics/geospatialworkbook/mybinder?urlpath=lab/tree/tutorials/Sentinel2_STAC.ipynb"><img src="https://mybinder.org/badge_logo.svg" alt="Binder" /></a></p>

<!-- Make the JupyterHub button live later

[![Ceres JupyterHub](https://img.shields.io/badge/launch-JupyterHub-579aca?logo=Jupyter)](https://jupyterhub.scinet.usda.gov/hub/user-redirect/git-pull?repo=https%3A%2F%2Fgithub.com%2Frmg55%2FCloudDAAC_Binders&urlpath=lab%2Ftree%2FCloudDAAC_Binders%2Fs3_v_http.ipynb&branch=main)

-->

<h2 id="overview">Overview</h2>

<p>Accessing, downloading, stacking, and working with earth observations (EO) data can be time-consuming, tedious, and generally in-efficient. Here we show how to leverage a SpatioTemporal Asset Catalog (STAC) to streamline the process of working with EO data.</p>

<h2 id="primary-librariespackages">Primary Libraries/Packages:</h2>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="http://xarray.pydata.org/en/stable/">xarray</a></td>
      <td>Labelled multi-dimensional arrays</td>
    </tr>
    <tr>
      <td><a href="https://hvplot.holoviz.org/">hvplot</a></td>
      <td>High-level plotting API built on <a href="https://holoviews.org/">HoloViews</a></td>
    </tr>
    <tr>
      <td><a href="https://geopandas.org/">geopandas</a></td>
      <td>Extends <a href="https://pandas.pydata.org/">Pandas</a> to allow spatial operations on geometric types</td>
    </tr>
    <tr>
      <td><a href="https://stackstac.readthedocs.io/en/latest/">stackstac</a></td>
      <td>Turns a STAC collection into a lazy xarray.DataArray, backed by dask.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/sat-utils/sat-search">satsearch</a></td>
      <td>Discovering/downloading satellite imagery using a STAC compliant API.</td>
    </tr>
  </tbody>
</table>

<h2 id="nomenclature">Nomenclature</h2>

<ul>
  <li><em>SpatioTemporal Asset Catalog (STAC)</em>: A ~json catalog to standardize the way geospatial asset metadata is structured and queried.</li>
  <li><em>Lazy Loading</em>: Delaying the loading of data until the object is called/computed. This can improve performance and reduce system resource use.</li>
  <li><em>Transform/Affine</em>: A matrix that maps the pixels in a raster to physical coordiantes (x, y). This consists of six elements, upper-left x coordinate, upper-left y coordinate, w-e pixel resolution, n-s pixel resolution, row rotation (typically zero), and the column rotation (typically zero).</li>
  <li><em>Amazon Web Services (AWS)</em>: Cloud computing platform by Amazon.</li>
  <li>Amazon Simple Storage Service (S3): The AWS object storage service.</li>
  <li><em>Sentinel 2</em>: Two polar-orbiting satellites monitoring variability in land surface conditions. The revisit freqency is 5-days at the equator and 2-3 days at mid-latitudes.</li>
  <li><em>Central Plains Experimental Range (CPER)</em>: A research station in the Long Term Agro-ecosystem Research (LTAR) network operated by the USDA ARS.</li>
  <li><em>Military Grid Reference System (MGRS)</em>: Grid system used to tile Sentinel 2 data products.</li>
  <li><em>Normalized Difference Vegetation Index (NDVI)</em>: A spectral index using the Red and Near Infrared spectra to estimate green (photosynthetically active) vegetation.</li>
  <li><em>Cloud Optimized Geotiff (COG)</em>: A GeoTiff file that has a specialized internal organization that enables cloud computing workflows.</li>
</ul>

<h2 id="data-details">Data Details</h2>

<ul>
  <li>Repository: <a href="https://registry.opendata.aws/">AWS</a></li>
  <li>Data: <a href="https://sentinel.esa.int/web/sentinel/user-guides/sentinel-2-msi/product-types/level-2a">Sentinel 2 L2A</a></li>
  <li>Link: https://registry.opendata.aws/sentinel-2-l2a-cogs/</li>
  <li><a href="https://stacindex.org/catalogs/earth-search#/Cnz1sryATwWudkxyZekxWx6356v9RmvvCcLLw79uHWJUDvt2">STAC Catalog Viewer</a></li>
</ul>

<h2 id="analysis-steps">Analysis Steps</h2>
<ol>
  <li><strong><a href="#roi">Define the ROI</a></strong>
    - Read a shapefile of the USDA ARS LTAR Central Plains Experimental Range. This will be the region of interest (ROI) for this tutorial</li>
  <li><strong><a href="#stac_func">STAC Search Query Function</a></strong>
    - Define a function to Query a STAC catalog. Inputs are:
    <ul>
      <li>url of the catalog</li>
      <li>dataset/collection</li>
      <li>dates range of interest</li>
      <li>bounding box</li>
    </ul>
  </li>
  <li><strong><a href="#stac1">Query Sentinel 2 Catalog</a></strong>
    - Selects from the catalog for MRGS tiles that interest our ROI (see step 1)
    - Use the query results (python dictionary) to create an xarray object</li>
  <li><strong><a href="#stac2">Query Sentinel 2 Catalog for 2019</a></strong>
    - Selects from the catalog for MRGS tiles that interest our ROI (see step 1)
    - Limit the data to scenes (MRGS tiles) to the year 2019 (e.g. 2019-01-01 - 2019-12-31).
    - Use the query results (python dictionary) to create an xarray object. Subset to the Red, NIR, and QA bands.</li>
  <li><strong><a href="#subset">Subset and Mask to the CPER ROI</a></strong>
    - Using the xarray object from Step 4, clip the xarray object to the ROI (CPER bounding box).
    - Apply a mask using the CPER shapefile (pixels outside the shapefile will be changed to null).</li>
  <li><strong><a href="#ndvi">Apply QA Band &amp; Calculate NDVI</a></strong>
    - Apply the QA band to the NIR and Red bands to remove “bad pixels” (i.e. clouds, water, snow, ice, etc…)
    - Calculate the Normalized Differenced Vegetation Index (NDVI)</li>
  <li><strong><a href="#plot">Explore and Plot</a></strong>
    - Bring data to memory (e.g. download from AWS) using <code class="language-plaintext highlighter-rouge">.compute()</code>.
    - Select a single time-step (2019-06-28) and plot the image.
    - Select a single pixel to get a time-series and plot the time series.
    - Calculate the average NDVI per time step and plot the time series.</li>
</ol>

<h3 id="step-0-import-libraries--packages">Step 0: Import Libraries / Packages</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="p">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">'ignore'</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">holoviews</span> <span class="k">as</span> <span class="n">hv</span>
<span class="n">hv</span><span class="p">.</span><span class="n">extension</span><span class="p">(</span><span class="s">'bokeh'</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">hvplot.xarray</span><span class="p">,</span><span class="n">hvplot</span><span class="p">.</span><span class="n">pandas</span><span class="p">,</span><span class="n">stackstac</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="n">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">from</span> <span class="nn">rasterio</span> <span class="kn">import</span> <span class="n">features</span><span class="p">,</span><span class="n">transform</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">satsearch</span> <span class="kn">import</span> <span class="n">Search</span>
</code></pre></div></div>

<h3 id="step-1-define-the-roi">Step 1: Define the ROI</h3>

<p>Read a shapefile of the USDA ARS LTAR Central Plains Experimental Range. This will be the region of interest (ROI) for this tutorial.</p>

<p>If you are new to geosptial data or not familiar with the idea of “projections”, please see:<br />
Projections Tutorial: https://datacarpentry.org/organization-geospatial/03-crs/<br />
EPSG Site: https://epsg.io/</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Read the shapefile into the geopandas dataframe
</span><span class="n">cper_shp</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">read_file</span><span class="p">(</span><span class="s">'https://raw.githubusercontent.com/rmg55/test_dashboard/master/data/cper.geojson'</span><span class="p">)</span>

<span class="c1"># Get the bounds of the shapefile (ROI) in both espg:4326 (geographic - lat. and long.) and epsg:32613 (projected - cartesian coords. in meters)
#This bounding box will be used to find Sentinel Tiles that intersect with our ROI
</span><span class="n">cper_bnds_4326</span> <span class="o">=</span> <span class="n">cper_shp</span><span class="p">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">4326</span><span class="p">).</span><span class="n">total_bounds</span>

<span class="c1">#This bounding box will be used to clip the Sentinel L2A tiles to the extent our our ROI
</span><span class="n">cper_bnds_32613</span> <span class="o">=</span> <span class="n">cper_shp</span><span class="p">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">32613</span><span class="p">).</span><span class="n">total_bounds</span>

<span class="c1">#Plot the shapefile/ROI
</span><span class="n">cper_shp</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Past_Name_'</span><span class="p">:</span><span class="s">'Pasture'</span><span class="p">}).</span><span class="n">hvplot</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="mi">32613</span><span class="p">,</span>
                                                           <span class="n">alpha</span><span class="o">=</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span>
                                                           <span class="n">line_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                           <span class="n">hover</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                           <span class="n">tiles</span><span class="o">=</span><span class="s">'ESRI'</span><span class="p">,</span>
                                                           <span class="n">c</span><span class="o">=</span><span class="s">'Pasture'</span><span class="p">,</span>
                                                           <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                           <span class="n">title</span><span class="o">=</span><span class="s">'Central Plain Experimental Range'</span><span class="p">,</span>
                                                           <span class="n">frame_width</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
</code></pre></div></div>

<p>Plot of the shape file :</p>

<p><img src="/ImportingData/assets/shapeFile.png" alt="shape file" /></p>

<h3 id="step-2-stac-search-query-function">Step 2: STAC Search Query Function</h3>

<p>Define a function to Query a STAC catalog. Inputs are:</p>
<ul>
  <li>url of the catalog</li>
  <li>dataset/collection</li>
  <li>date range of interest</li>
  <li>bounding box</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_STAC_items</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">bbox</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">Search</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                            <span class="n">collections</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                            <span class="n">datetime</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span>
                            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="step-3-query-sentinel-2-catalog">Step 3: Query Sentinel 2 Catalog</h3>
<ul>
  <li>Selects from the catalog for MRGS tiles that interest our ROI (see step 1)</li>
  <li>Use the query results (python dictionary) to create an xarray object</li>
</ul>

<p>Note that this is using a lazy-loading approach, where only the metadata is read from the files/stac catalog, rather than downloading the entire <strong>7.52 TB</strong> dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the parameters to search the STAC catalog
</span><span class="n">url</span> <span class="o">=</span> <span class="s">'https://earth-search.aws.element84.com/v0'</span>
<span class="n">collection</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sentinel-s2-l2a-cogs'</span><span class="p">]</span>
<span class="n">bbox</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cper_bnds_4326</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="s">'1901-01-01/2090-12-31'</span> <span class="c1">#Ge the entire data range of the data.
</span>
<span class="c1"># Query the catalog
</span><span class="n">stac_items</span> <span class="o">=</span> <span class="n">get_STAC_items</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">dates</span><span class="p">,</span><span class="n">bbox</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>

<span class="c1"># Transform into an Xarray object
</span><span class="n">stackstac</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stac_items</span><span class="p">.</span><span class="n">geojson</span><span class="p">()[</span><span class="s">'features'</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="/ImportingData/assets/xarrayObject.png" alt="X-array-object" /></p>

<h3 id="step-4-query-sentinel-2-catalog-for-2019">Step 4: Query Sentinel 2 Catalog for 2019</h3>

<ul>
  <li>Selects from the catalog for MRGS tiles that interest our ROI (see step 1)</li>
  <li>Limit the data to scenes (MRGS tiles) to the year 2019 (e.g. 2019-01-01 - 2019-12-31).</li>
  <li>Use the query results (python dictionary) to create an xarray object. Subset to the Red, NIR, and QA bands.</li>
</ul>

<p>The dataset is reduced to <strong>396 GB</strong> (from 7.52 TB) by subseting the data to 2019 and selecting the 3-bands of interest for our analysis.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the parameters to search the STAC catalog
</span><span class="n">url</span> <span class="o">=</span> <span class="s">'https://earth-search.aws.element84.com/v0'</span>
<span class="n">collection</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sentinel-s2-l2a-cogs'</span><span class="p">]</span>
<span class="n">bbox</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cper_bnds_4326</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="s">'2019-01-01/2019-12-31'</span> <span class="c1">#Just 2019
</span>
<span class="c1"># Query the catalog
</span><span class="n">stac_items</span> <span class="o">=</span> <span class="n">get_STAC_items</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">collection</span><span class="p">,</span><span class="n">dates</span><span class="p">,</span><span class="n">bbox</span><span class="p">).</span><span class="n">items</span><span class="p">()</span>

<span class="c1"># Lets look at a calendar
</span><span class="k">print</span><span class="p">(</span><span class="n">stac_items</span><span class="p">.</span><span class="n">calendar</span><span class="p">())</span>
</code></pre></div></div>

<p><img src="/ImportingData/assets/calender.png" alt="calender" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Lets examine a single asset (band) within a single STAC Item (date)
</span><span class="n">stac_dict</span> <span class="o">=</span> <span class="n">stac_items</span><span class="p">.</span><span class="n">geojson</span><span class="p">()</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">stac_dict</span><span class="p">[</span><span class="s">'features'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'assets'</span><span class="p">][</span><span class="s">'B04'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Transform into an Xarray object and read only the 3 bands we want (Red, NIR, and QA)
</span><span class="n">da</span> <span class="o">=</span> <span class="n">stackstac</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stac_dict</span><span class="p">[</span><span class="s">'features'</span><span class="p">],</span><span class="n">assets</span><span class="o">=</span><span class="p">[</span><span class="s">'B04'</span><span class="p">,</span><span class="s">'B08'</span><span class="p">,</span><span class="s">'SCL'</span><span class="p">])</span>
<span class="n">da</span>
</code></pre></div></div>
<p><img src="/ImportingData/assets/3BandObject.png" alt="3-band object" /></p>

<h3 id="step-5-subset-and-mask-to-the-cper-roi">Step 5: Subset and Mask to the CPER ROI</h3>

<ul>
  <li>Using the xarray object from Step 4, clip the xarray object to the ROI (CPER bounding box).</li>
  <li>Apply a mask using the CPER shapefile (pixels outside the shapefile will be changed to null).</li>
</ul>

<p>The dataset is reduced to 3.05 GB (from 396 GB) by clipping the data the bounding box of the ROI. Note that we use two functions to “mask” the data that falls within the ROI bounding box, but outside the domain (perimeter) of the CPER. The first function xr_2_affine, takes an xarray object, and calculates the affine transform (see nominclature section). The second function, shp2mask, rasterizes a shapefile (0’s=outside and 1’s=inside the shapefile) to match the same dimensions of the xarray object.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get the bounds in epsg:32613 and apply to the xarray object
</span><span class="n">minx</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">maxy</span> <span class="o">=</span> <span class="n">cper_bnds_32613</span>
<span class="n">da_cper</span> <span class="o">=</span> <span class="n">da</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">),</span><span class="n">y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">maxy</span><span class="p">,</span><span class="n">miny</span><span class="p">)).</span><span class="n">rename</span><span class="p">(</span><span class="s">'CPER'</span><span class="p">)</span>
<span class="n">da_cper</span>
</code></pre></div></div>
<p><img src="/ImportingData/assets/Masking.png" alt="Mask" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Function to calculate the affine transform from an xarray object
</span><span class="k">def</span> <span class="nf">xr_2_affine</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">x_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x_scale</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">y_scale</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">upperleft_x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">x_scale</span>
    <span class="n">upperleft_y</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">y_scale</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transform</span><span class="p">.</span><span class="n">Affine</span><span class="p">(</span><span class="n">x_scale</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">upperleft_x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">y_scale</span><span class="p">,</span><span class="n">upperleft_y</span><span class="p">))</span>

<span class="c1"># Define a function to mask the xarray object with a shapefile
</span><span class="k">def</span> <span class="nf">shp2mask</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span><span class="n">xr_object</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">raster</span> <span class="o">=</span> <span class="n">features</span><span class="p">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                                <span class="n">transform</span><span class="o">=</span><span class="n">xr_2_affine</span><span class="p">(</span><span class="n">xr_object</span><span class="p">),</span>
                                <span class="n">out_shape</span><span class="o">=</span><span class="n">xr_object</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">band</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">cper</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="s">'int16'</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span>
                        <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">xr_object</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
                                <span class="n">xr_object</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">'x'</span><span class="p">]),</span>
                        <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="s">'x'</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### Create a Mask ###
# Convert DataArray to DataSet
</span><span class="n">da_cper</span> <span class="o">=</span> <span class="n">da_cper</span><span class="p">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'cper'</span><span class="p">)</span>
<span class="c1"># Create a single polygon to use as a mask
</span><span class="n">cper_shp_mask</span> <span class="o">=</span> <span class="n">cper_shp</span><span class="p">.</span><span class="n">dissolve</span><span class="p">().</span><span class="nb">buffer</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nb">buffer</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">).</span><span class="n">geometry</span><span class="p">.</span><span class="n">values</span>
<span class="c1"># Add CPER mask (a DataArray) to the DataSet
</span><span class="n">da_cper</span><span class="p">[</span><span class="s">'cper_mask'</span><span class="p">]</span> <span class="o">=</span> <span class="n">shp2mask</span><span class="p">(</span><span class="n">cper_shp_mask</span><span class="p">,</span><span class="n">da_cper</span><span class="p">)</span>

<span class="c1"># Apply the CPER mask and remap the data back to DataArray (from a DataSet)
</span><span class="n">da_cper</span> <span class="o">=</span> <span class="n">da_cper</span><span class="p">.</span><span class="n">cper</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_cper</span><span class="p">.</span><span class="n">cper_mask</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<h3 id="step-6-apply-qa-band-and-calculate-ndvi">Step 6: Apply QA Band and Calculate NDVI</h3>

<ul>
  <li>Apply the QA band to the NIR and Red bands to remove “bad pixels” (i.e. clouds, water, snow, ice, etc…)</li>
  <li>Calculate the Normalized Differenced Vegetation Index (NDVI)</li>
</ul>

<p>The dataset is reduced to <strong>1.02 GB</strong> by reducing the bands from red, nir, and QA/QC to just NDVI.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Apply the QA band
</span><span class="n">mask</span> <span class="o">=</span> <span class="n">da_cper</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s">'SCL'</span><span class="p">).</span><span class="n">isin</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">da_cper</span> <span class="o">=</span> <span class="n">da_cper</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">).</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="s">'B04'</span><span class="p">,</span><span class="s">'B08'</span><span class="p">])</span>

<span class="c1"># Calculate NDVI
</span><span class="n">Red</span> <span class="o">=</span> <span class="n">da_cper</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s">'B04'</span><span class="p">)</span>
<span class="n">NIR</span> <span class="o">=</span> <span class="n">da_cper</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s">'B08'</span><span class="p">)</span>
<span class="n">da_cper_ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">NIR</span> <span class="o">-</span> <span class="n">Red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">NIR</span> <span class="o">+</span> <span class="n">Red</span><span class="p">)</span>
<span class="n">da_cper_ndvi</span> <span class="o">=</span> <span class="n">da_cper_ndvi</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s">'NDVI'</span><span class="p">)</span>
<span class="n">da_cper_ndvi</span>
</code></pre></div></div>

<p><img src="/ImportingData/assets/NDVI.png" alt="NDVI" /></p>

<h3 id="step-7-explore-and-plot">Step 7: Explore and Plot</h3>

<ul>
  <li>Bring data to memory (e.g. download from AWS) using <code class="language-plaintext highlighter-rouge">compute()</code>.</li>
  <li>Select a single time-step <code class="language-plaintext highlighter-rouge">2019-06-28</code> and plot the image.</li>
  <li>Select a single pixel to get a time-series and plot the time series.</li>
  <li>Calculate the average NDVI (across CPER) per time step and plot the time series.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bring data to memory (e.g. download from AWS)
# Depending on your internet speed, this can take 10's of seconds - ~ 5 minutes
</span><span class="n">da_cper_ndvi</span> <span class="o">=</span> <span class="n">da_cper_ndvi</span><span class="p">.</span><span class="n">compute</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Query a single date / image
</span><span class="n">t</span> <span class="o">=</span> <span class="s">'2019-06-28'</span>
<span class="n">da_cper_ndvi_plot</span> <span class="o">=</span> <span class="n">da_cper_ndvi</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

<span class="c1"># Plot the image as well as the CPER shape file (showing pastures)
</span><span class="n">da_cper_ndvi_plot</span><span class="p">.</span><span class="n">squeeze</span><span class="p">().</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'x'</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span>
                                   <span class="n">tiles</span><span class="o">=</span><span class="s">'ESRI'</span><span class="p">,</span>
                                   <span class="n">crs</span><span class="o">=</span><span class="mi">32613</span><span class="p">,</span>
                                   <span class="n">cmap</span><span class="o">=</span><span class="s">'viridis'</span><span class="p">,</span>
                                   <span class="n">clim</span><span class="o">=</span><span class="p">(.</span><span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="mi">65</span><span class="p">),</span>
                                   <span class="n">title</span><span class="o">=</span><span class="s">'CPER NDVI on '</span><span class="o">+</span><span class="n">t</span><span class="p">,</span>
                                   <span class="n">frame_width</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span> <span class="o">*</span> \
<span class="n">cper_shp</span><span class="p">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="mi">32613</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">line_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">hover</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/ImportingData/assets/NDVI-singleDate.png" alt="NDVA SIngle date" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Quey a single pixel, for all the time steps
</span><span class="n">da_cper_ndvi_ts</span> <span class="o">=</span> <span class="n">da_cper_ndvi</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_cper_ndvi</span><span class="o">&gt;</span><span class="p">.</span><span class="mi">1</span><span class="p">).</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">450</span><span class="p">).</span><span class="n">rename</span><span class="p">(</span><span class="s">'NDVI'</span><span class="p">)</span>

<span class="c1"># Plot the raw time series as well as a weekly max time series
</span><span class="n">pt_str</span> <span class="o">=</span> <span class="s">'(x='</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">da_cper_ndvi_ts</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">values</span><span class="p">))</span><span class="o">+</span><span class="s">',y='</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">da_cper_ndvi_ts</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">values</span><span class="p">))</span><span class="o">+</span><span class="s">')'</span>
<span class="n">da_cper_ndvi_ts</span><span class="p">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'time'</span><span class="p">,</span>
                       <span class="n">kind</span><span class="o">=</span><span class="s">'scatter'</span><span class="p">,</span>
                       <span class="n">title</span><span class="o">=</span><span class="s">'NDVI '</span><span class="o">+</span><span class="n">pt_str</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                       <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> \
<span class="n">da_cper_ndvi_ts</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'time.weekofyear'</span><span class="p">).</span><span class="nb">max</span><span class="p">().</span><span class="n">hvplot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'scatter'</span><span class="p">,</span>
                                                        <span class="n">title</span><span class="o">=</span><span class="s">'Weekly Max NDVI '</span><span class="o">+</span><span class="n">pt_str</span><span class="p">,</span>
                                                        <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                                        <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/ImportingData/assets/NDVI-plot.png" alt="plot" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get the mean for the entire Domain at each time step
</span><span class="n">da_cper_ndvi_tsall</span> <span class="o">=</span> <span class="n">da_cper_ndvi</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">da_cper_ndvi</span><span class="o">&gt;</span><span class="p">.</span><span class="mi">1</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">])</span>

<span class="c1"># Plot the NDVI time series
</span><span class="n">da_cper_ndvi_tsall</span><span class="p">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'time'</span><span class="p">,</span>
                          <span class="n">kind</span><span class="o">=</span><span class="s">'scatter'</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s">'Avg. NDVI across CPER'</span><span class="p">,</span>
                          <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre></div></div>

<p><img src="/ImportingData/assets/average-NDVI-plot.png" alt="average-plot" /></p>

<h3 id="concluding-remarks">Concluding Remarks:</h3>

<p>A traditional workflow would involve downloading individual tiles that intersect the ROI, which for 2019, would be 396 GB, and then subsetting the data once it is in local storage. Assuming a download speed of 100 Mbps, this approach would take ~8.8 hours to simply download all the tiles. Here we have shown how to leverage a SpatioTemporal Asset Catalog to analyze EO data. The data is stored in Cloud Optimized Geotiffs (COGs), which allows efficient data access to particular chunks of the file (via http range requests). Using python packages that “lazily loading” the data, we are able to efficiently build out a workflow to subset, mask, and apply calculations (NDVI) before beginning the process of downloading the data. Finally, we “compute” the results into memory (Step 7), and are able to work with a much more managable dataset (1.0 GB).</p>

        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      

    </div>

    
  </article>

  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id">
    <input type="search" id="cse-search-input-box-id" aria-placeholder="Enter your search term..." class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    </form>
    <div id="results" class="results">
        <gcse:searchresults-only></gcse:searchresults-only>
    </div></div>

      </div>
    
    
    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/isugif"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="https://github.com/https://github.com/isugenomics"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Geospatial Workbook</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>


<script>
  (function () {
    var cx = '009853197685285203469:nsvri1pa88d';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
</script>




<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" defer
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>




  </body>
</html>
