<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.2 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Handling vector data - Geospatial Workbook</title>
<meta name="description" content="Tutorial on Informatics for Geospatial Information">


  <meta name="author" content="Heather Savoy">


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Geospatial Workbook">
<meta property="og:title" content="Handling vector data">
<meta property="og:url" content="http://localhost:4000/ExampleGeoWorkflows/GRWG22_VectorData_R.html">




  <meta property="og:image" content="http://localhost:4000/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg">



  <meta name="twitter:site" content="@isugif">
  <meta name="twitter:title" content="Handling vector data">
  <meta name="twitter:description" content="Tutorial on Informatics for Geospatial Information">
  <meta name="twitter:url" content="http://localhost:4000/ExampleGeoWorkflows/GRWG22_VectorData_R.html">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg">
  

  
    <meta name="twitter:creator" content="@someone">
  







  

  


<link rel="canonical" href="http://localhost:4000/ExampleGeoWorkflows/GRWG22_VectorData_R.html">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Geospatial Workbook Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E6BZVYF8ZY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E6BZVYF8ZY');
</script>

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Geospatial Workbook</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about.html" >About</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/list.html" >Index</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/glossary.html" >Glossary</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/people.html" >People</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/contributing.html" >Contribute</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style="background-color: 444444; background-image: url('/assets/images/margaret-weir-GZyjbLNOaFg-unsplash_dark.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Handling vector data

        
      </h1>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/people/HeatherSavoy.png" alt="Heather Savoy" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Heather Savoy</h3>
    
    
      <p class="author__bio" itemprop="description">
        Heather is a Computational Biologist (Data Scientist) in the USDA-ARS SCINet Office. Her research interests include applying informatics methods to multidisciplinary agro-ecosystem problems and building data science software tools for geospatial research. She received her Ph.D. in Civil and Environmental Engineering with an emphasis in Computational Data Science and Engineering from the University of California Berkeley. She also holds a B.S. in Environmental Science with a minor in Computational Mathematics from the Florida Institute of Technology.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      
        <li>
          <a href="mailto:mailto:heather.savoy@usda.gov">
            <meta itemprop="email" content="mailto:heather.savoy@usda.gov" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/someone" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

<!-- Create a 2nd author for tutorials -->



<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Handling vector data">
    
    
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Last Update:</strong> 7 October 2022 <br />
<strong>Download RMarkdown</strong>: <a href="https://geospatial.101workbook.org/tutorials/GRWG22_VectorData.Rmd">GRWG22_VectorData.Rmd</a></p>

<!-- ToDo: would be great to have an R binder badge here -->

<h2 id="overview">Overview</h2>

<p>This tutorial covers how to manipulate geospatial vector datasets in R. A 
dataset with polygon geometries representing wildfire perimeters is joined with 
a dataset with point geometries representing air quality monitoring stations to
determine which stations observed unhealthy concentrations of small particulate 
matter (PM2.5) in the atmosphere around the time
of the Camp Fire in northern CA in 2018.</p>

<p>This tutorial assumes you are running this Rmarkdown file in RStudio Server. The 
easiest way to do that is with Open OnDemand (OoD) on <a href="http://ceres-ood.scinet.usda.gov/">Ceres</a>
or <a href="https://atlas-ood.hpc.msstate.edu/">Atlas</a>. 
Select the following parameter values when requesting a RStudio Server
app to be launched depending on which cluster you choose. All other values can 
be left to their defaults. Note: on Atlas, we are using the development partition
so that we have internet access to download files since the regular compute nodes
on the <code class="language-plaintext highlighter-rouge">atlas</code> partition do not have internet access.</p>

<p>Ceres:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Slurm Partition</code>: short</li>
  <li><code class="language-plaintext highlighter-rouge">R Version</code>: 4.2.0</li>
  <li><code class="language-plaintext highlighter-rouge">Number of hours</code>: 1</li>
  <li><code class="language-plaintext highlighter-rouge">Number of cores</code>: 2</li>
</ul>

<p>Atlas:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">R Version</code>: 4.1.0</li>
  <li><code class="language-plaintext highlighter-rouge">Partition Name</code>: development</li>
  <li><code class="language-plaintext highlighter-rouge">QOS</code>: normal</li>
  <li><code class="language-plaintext highlighter-rouge">Number of hours</code>: 1</li>
  <li><code class="language-plaintext highlighter-rouge">Number of tasks</code>: 2</li>
</ul>

<p>To download the Rmarkdown file for this tutorial to either cluster within OoD, 
you can use the following lines:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">httr</span><span class="p">)</span><span class="w">
</span><span class="n">tutorial_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'GRWG22_VectorData.Rmd'</span><span class="w">
</span><span class="n">GET</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s1">'https://geospatial.101workbook.org/tutorials/'</span><span class="p">,</span><span class="n">tutorial_name</span><span class="p">),</span><span class="w"> 
    </span><span class="n">write_disk</span><span class="p">(</span><span class="n">tutorial_name</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p><em>Language:</em> <code class="language-plaintext highlighter-rouge">R</code></p>

<p><em>Primary Libraries/Packages:</em></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Name</th>
      <th style="text-align: left">Description</th>
      <th style="text-align: left">Link</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">sf</code></td>
      <td style="text-align: left">Simple features for R</td>
      <td style="text-align: left">https://cran.r-project.org/web/packages/sf/index.html</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">USAboundaries</code></td>
      <td style="text-align: left">Historical and Contemporary Boundaries of the United States of America</td>
      <td style="text-align: left">https://cran.r-project.org/web/packages/USAboundaries/index.html</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ggplot2</code></td>
      <td style="text-align: left">Create Elegant Data Visualisations Using the Grammar of Graphics</td>
      <td style="text-align: left">https://cran.r-project.org/web/packages/ggplot2/index.html</td>
    </tr>
  </tbody>
</table>

<h2 id="nomenclature">Nomenclature</h2>

<ul>
  <li><em>Vector data:</em> Spatial data defined by simple geometry types (points, lines, 
and polygons) where each geometry feature can be assigned non-spatial attributes.</li>
  <li><em>CRS:</em> Coordinate Reference System, also known as a spatial reference system. A
system for defining geospatial coordinates.</li>
  <li><em>Spatial join:</em> Combining two spatial datasets by the relationship between their
geometries.</li>
</ul>

<h2 id="data-details">Data Details</h2>

<ul>
  <li>Data: National Interagency Fire Center’s Historic Perimeters dataset</li>
  <li>Link: <a href="https://data-nifc.opendata.arcgis.com/datasets/nifc::historic-perimeters-combined-2000-2018-geomac/explore">https://data-nifc.opendata.arcgis.com/datasets/nifc::historic-perimeters-combined-2000-2018-geomac/explore</a></li>
  <li>
    <p>Other Details: The original dataset contains perimeters of wildfires in the US 
from 2000-2018 as a polygon feature collection. For this tutorial, the wildfire
perimeters in CA during 2018 were extracted.</p>
  </li>
  <li>Data: US EPA’s Air Quality System (AQS) database</li>
  <li>Link: <a href="https://aqs.epa.gov/aqsweb/documents/data_api.html">https://aqs.epa.gov/aqsweb/documents/data_api.html</a></li>
  <li>Other Details: PM2.5 concentration data from this database covering CA in 2018 
were retrieved and pre-processed for this tutorial.</li>
</ul>

<h2 id="analysis-steps">Analysis Steps</h2>

<ul>
  <li>Fire perimeter data - read in and visualize the wildfire perimeter data
    <ul>
      <li>Read in geojson file</li>
      <li>Visualize perimeters on map of CA</li>
      <li>Visualize non-spatial attributes</li>
    </ul>
  </li>
  <li>Air quality data - read in the shapefile</li>
  <li>Buffer and spatial join - find the air quality stations within 200km of the 
fire perimeter</li>
  <li>Visualize - air quality impact around the Camp Fire</li>
</ul>

<h2 id="step-0-import-librariespackages">Step 0: Import Libraries/Packages</h2>
<p>For this tutorial, we will use the <code class="language-plaintext highlighter-rouge">sf</code> package for handling vector data,
the <code class="language-plaintext highlighter-rouge">USAboundaries</code> for including state boundaries in our maps, 
<code class="language-plaintext highlighter-rouge">dplyr</code> for general tabular data manipulations, <code class="language-plaintext highlighter-rouge">ggplot2</code> for creating
visuals, and <code class="language-plaintext highlighter-rouge">lubridate</code> for handling dates. Each package except <code class="language-plaintext highlighter-rouge">USAboundaries</code>
is available from the site libraries accessible to RStudio Server on OoD for 
both clusters. If you have not used <code class="language-plaintext highlighter-rouge">USAboundaries</code> before, you may install it 
from CRAN with <code class="language-plaintext highlighter-rouge">install.packages(USAboundaries)</code> from within RStudio Server on OoD.
To learn more about installing packages on Ceres, see 
<a href="https://scinet.usda.gov/guide/packageinstall/#installing-r-packages">this guide</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">               </span><span class="c1"># Handling vector data</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">USAboundaries</span><span class="p">)</span><span class="w">    </span><span class="c1"># Mapping administrative boundaries</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">            </span><span class="c1"># General data manipulation</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">          </span><span class="c1"># Visualizations</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">        </span><span class="c1"># Date manipulation</span><span class="w">
</span></code></pre></div></div>

<h2 id="step-1-read-in-fire-perimeter-data-and-visualize">Step 1: Read in fire perimeter data and visualize</h2>

<p>The National Interagency Fire Center’s Historic Perimeters dataset has 23,776 
polygons representing wildfire perimeters from 2000-2018. A version of the dataset 
filtered to wildfires in CA in 2018, since that is when the 
destructive Camp Fire occurred, will be used in this tutorial.</p>

<p>We will transform to planar coordinates for distance calculations. The 5070 EPSG
code is for the Equal Area CONUS Albers. If you kept the dataset in it’s 
original CRS, WGS 84, <code class="language-plaintext highlighter-rouge">sf</code> would warn you about distance calculations not being 
accurate.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fire_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'Historic_Perimeters_Combined_2000-2018_GeoMAC_CA2018.geojson'</span><span class="w">
</span><span class="n">dnld_url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'https://geospatial.101workbook.org/ExampleGeoWorkflows/assets/'</span><span class="w">
</span><span class="n">httr</span><span class="o">::</span><span class="n">GET</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">dnld_url</span><span class="p">,</span><span class="n">fire_f</span><span class="p">),</span><span class="w">
          </span><span class="n">httr</span><span class="o">::</span><span class="n">write_disk</span><span class="p">(</span><span class="n">fire_f</span><span class="p">,</span><span class="w">
                           </span><span class="n">overwrite</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span><span class="w">

</span><span class="n">fire_CA2018</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">fire_f</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">st_transform</span><span class="p">(</span><span class="m">5070</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>To get an idea of what the data look like, we can create a map.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CA boundary</span><span class="w">
</span><span class="n">CA</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">us_states</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
            </span><span class="n">filter</span><span class="p">(</span><span class="n">state_abbr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'CA'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">st_transform</span><span class="p">(</span><span class="n">st_crs</span><span class="p">(</span><span class="n">fire_CA2018</span><span class="p">))</span><span class="w">

</span><span class="c1"># The Camp Fire feature</span><span class="w">
</span><span class="n">camp_fire</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fire_CA2018</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">incidentname</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'CAMP'</span><span class="p">)</span><span class="w">

</span><span class="c1"># Plot a map of all wildfires and </span><span class="w">
</span><span class="c1"># highlight the Camp Fire.</span><span class="w">
</span><span class="n">fire_CA2018</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CA</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w">
          </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'red'</span><span class="p">,</span><span class="w">
          </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
          </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camp_fire</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<p><img src="/ExampleGeoWorkflows/assets/R_fire_map-1.png" alt="fire_map" /></p>

<p>Since this feature collection has several attributes, we can also visualize, 
for example, when the fires occurred during the year. Note that the dates are
when the fires’ perimeters are established, not when the fires start. Since fires 
can endure for many days and change their spatial extent over that time, this
date is when the maximum extent of the fire was determined, which needs to be 
at the end of the fire.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plotting when wildfires occurred throughout 2018</span><span class="w">
</span><span class="n">fire_CA2018</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">perimeterdatetime</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">perimeterdatetime</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'1 month'</span><span class="p">,</span><span class="w">
                   </span><span class="n">date_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%b'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><img src="/ExampleGeoWorkflows/assets/R_fire_time-1.png" alt="fire_time" /></p>

<h2 id="step-2-read-in-air-quality-data">Step 2: Read in air quality data</h2>

<p>We will read in an air quality dataset to showcase combining multiple vector 
datasets. The geometry type is point, representing sampling stations. This 
dataset can be downloaded with an API, but you need to register an account, so 
the download process has been done already and the data are available in our 
‘session6’ folder. Some pre-processing for this dataset was done to make it into 
a feature collection.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">aq_base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'air_quality_CA2018'</span><span class="w">
</span><span class="n">aq_zip</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">aq_base</span><span class="p">,</span><span class="s1">'.zip'</span><span class="p">)</span><span class="w">
</span><span class="c1">#dnld_url &lt;- 'https://github.com/HeatherSavoy-USDA/geospatialworkbook/raw/master/ExampleGeoWorkflows/assets/'</span><span class="w">
</span><span class="n">httr</span><span class="o">::</span><span class="n">GET</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">dnld_url</span><span class="p">,</span><span class="n">aq_zip</span><span class="p">),</span><span class="w">
          </span><span class="n">httr</span><span class="o">::</span><span class="n">write_disk</span><span class="p">(</span><span class="n">aq_zip</span><span class="p">,</span><span class="w">
                           </span><span class="n">overwrite</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span><span class="n">unzip</span><span class="p">(</span><span class="n">aq_zip</span><span class="p">)</span><span class="w">

</span><span class="n">ca_PM25</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_read</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">aq_base</span><span class="p">,</span><span class="s1">'.shp'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">st_transform</span><span class="p">(</span><span class="n">st_crs</span><span class="p">(</span><span class="n">fire_CA2018</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<h2 id="step-3-find-the-air-quality-stations-within-200km-of-the-fire-perimeter">Step 3: Find the air quality stations within 200km of the fire perimeter</h2>

<p>We will buffer the Camp Fire polygon and join that to the air quality data to 
find the nearby stations. Note that the direction of joining is important: the 
geometry of the left dataset, in this case the air quality points, will be 
retained and the attributes of intersecting features of the right dataset will 
be retained.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">camp_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">camp_fire</span><span class="p">,</span><span class="w"> </span><span class="m">200000</span><span class="p">)</span><span class="w"> </span><span class="c1"># meters, buffer is in unit of CRS</span><span class="w">

</span><span class="n">air_fire</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_join</span><span class="p">(</span><span class="n">ca_PM25</span><span class="p">,</span><span class="w"> </span><span class="n">camp_zone</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="step-4-visualize-air-quality-around-the-camp-fire">Step 4: Visualize air quality around the Camp Fire</h2>

<p>‘Around’ in this case should be in both space and time. We already found the 
air quality stations within 200 km from the fire perimeter. To make sure we are
looking at the right time of year, we will relate the non-spatial attributes of
the two feature collections. Both datasets come with date columns: when the air
quality was recorded and when the perimeter was determined (so the latter is 
an approximate time near the end of the fire). We will filter our spatially-
joined dataset to within 30 days of the fire perimeter date so we only consider
air quality within a 2-month window around the time of the fire.</p>

<p>We can then plot the air quality metric of PM2.5 concentration (lower is better) 
as a function of time before/after the fire perimeter date. Each line is an 
individual air quality station. The figure indicates that there were several 
stations that recorded unhealthy to hazardous PM2.5 concentrations around the
time of this wildfire.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Filter to 30 days from fire perimeter date</span><span class="w">
</span><span class="n">air_near_fire</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">air_fire</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">dat_lcl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ymd</span><span class="p">(</span><span class="n">dat_lcl</span><span class="p">),</span><span class="w"> </span><span class="c1"># local date for air quality measurement</span><span class="w">
         </span><span class="n">perimeterdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">perimeterdatetime</span><span class="p">),</span><span class="w"> </span><span class="c1"># fire perimeter date</span><span class="w">
         </span><span class="n">date_shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dat_lcl</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">perimeterdate</span><span class="p">,</span><span class="w">
         </span><span class="n">PM25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">arthmt_</span><span class="p">),</span><span class="w">
         </span><span class="n">station_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">stat_cd</span><span class="p">,</span><span class="w"> </span><span class="n">cnty_cd</span><span class="p">,</span><span class="w"> </span><span class="n">st_nmbr</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">filter</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">date_shift</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w">
  
</span><span class="c1"># Define bounds of Camp Fire dates for illustrative purposes</span><span class="w">
</span><span class="c1"># Camp Fire burned for 17 days- add a polygon to graph to visualize temporal overlap with low air quality</span><span class="w">
</span><span class="n">camp_dates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ymd</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s1">'2018-11-08'</span><span class="p">,</span><span class="s1">'2018-11-25'</span><span class="p">))</span><span class="w">

</span><span class="c1"># Camp Fire's maximum perimeter established at end of fire</span><span class="w">
</span><span class="n">fp_date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">air_near_fire</span><span class="o">$</span><span class="n">perimeterdate</span><span class="p">)</span><span class="w">


</span><span class="n">air_near_fire</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">tidyr</span><span class="o">::</span><span class="n">complete</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span><span class="w"> </span><span class="n">dat_lcl</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">dat_lcl</span><span class="p">,</span><span class="n">PM25</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">annotate</span><span class="p">(</span><span class="s1">'rect'</span><span class="p">,</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camp_dates</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camp_dates</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w">
            </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="kc">Inf</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">,</span><span class="w">
            </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'firebrick'</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">station_id</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fp_date</span><span class="p">,</span><span class="w"> 
             </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'red'</span><span class="p">,</span><span class="w">
             </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
             </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'dashed'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_x_date</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="n">date_breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1 week"</span><span class="p">,</span><span class="n">date_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%m-%d-%y"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'PM2.5 [micrograms/cubic meter]'</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<p><img src="/ExampleGeoWorkflows/assets/R_join_plot-1.png" alt="join_plot" /></p>

<p>We can then map where those stations were - quite an 
extensive impact on air quality!</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 101 micrograms/cubic meter and higher is considered</span><span class="w">
</span><span class="c1"># unhealthy for sensitive groups </span><span class="w">
</span><span class="n">unhealthy_air</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">air_near_fire</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">PM25</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">  

</span><span class="n">unhealthy_air</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CA</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'red'</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'firebrick'</span><span class="p">,</span><span class="w">
          </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
          </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camp_fire</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_sf</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'firebrick'</span><span class="p">,</span><span class="w">
          </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w">
          </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">camp_zone</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/ExampleGeoWorkflows/assets/R_unhealthy-1.png" alt="unhealthy" /></p>

        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      

    </div>

    
  </article>

  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id">
    <input type="search" id="cse-search-input-box-id" aria-placeholder="Enter your search term..." class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    </form>
    <div id="results" class="results">
        <gcse:searchresults-only></gcse:searchresults-only>
    </div></div>

      </div>
    
    
    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/isugif"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="https://github.com/https://github.com/isugenomics"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Geospatial Workbook</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>


<script>
  (function () {
    var cx = '009853197685285203469:nsvri1pa88d';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
</script>




<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" defer
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>




  </body>
</html>
